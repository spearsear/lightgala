angular.module("lightgalaApp",["d3","ngRoute","ngResource","ngAnimate","ngCookies","ngMessages","mgcrea.ngStrap","ui.bootstrap.tpls","ui.bootstrap.carousel","ui.bootstrap.pagination","uiGmapgoogle-maps","vcRecaptcha","colorpicker.module","radialgradient.module"]).constant("baseUrl","http://lightgala.com:3000/").config(["uiGmapGoogleMapApiProvider",function(a){a.configure({v:"3.17",libraries:"weather,geometry,visualization"})}]).config(["$locationProvider","$routeProvider","$httpProvider",function(a,b,c){a.html5Mode(!0);var d={checkEditPermission:["$rootScope","$location","Auth",function(a,b,c){return a.currentUser?!0:(c.saveAttemptedUrl(),void b.path("/login"))}]};c.interceptors.push("securityInterceptor"),b.when("/",{templateUrl:"partials/main.html",controller:"mainCtrl"}).when("/decor",{templateUrl:"/partials/decor.html",controller:"decorCtrl"}).when("/decor/template/:template_id",{templateUrl:"/partials/decor.html",controller:"decorCtrl"}).when("/decor/:id/edit",{templateUrl:"partials/decor.html",controller:"decorCtrl",resolve:{factory:d.checkEditPermission}}).when("/decor/:id",{templateUrl:"partials/decor_play.html"}).when("/login",{templateUrl:"partials/login.html",controller:"loginCtrl"}).when("/signup",{templateUrl:"partials/signup.html",controller:"signupCtrl"}).when("/about",{templateUrl:"/partials/about.html"}).when("/popular",{templateUrl:"/partials/popular.html"}).when("/privacy",{templateUrl:"/partials/privacy.html"}).when("/disclaimer",{templateUrl:"/partials/disclaimer.html"}).when("/company",{templateUrl:"/partials/company.html"}).when("/contact",{templateUrl:"/partials/contact.html"}).otherwise({redirectTo:"/"})}]).factory("securityInterceptor",["$q","$location","$cookieStore","$injector",function(a,b,c,d){var e={request:function(a){var b=d.get("Auth");return b.isLoggedIn()||(c.remove("user"),b.saveAttemptedUrl()),a},responseError:function(c){if(403===c.status){b.path("/");var e=d.get("$alert");e({title:"Edit forbidden!",content:"You can only edit lighting designed by yourself.",placement:"top-right",type:"danger",duration:3})}return a.reject(c)}};return e}]).run(function(){}),angular.module("lightgalaApp").filter("show_eye_icon",function(){return function(a){return void 0==a?"glyphicon-eye-close":a?"glyphicon-eye-close":"glyphicon-eye-open"}}).filter("selectDecorLineFilter",function(){return function(a,b){return _.filter(a,function(a){return a.decor_line_type.toLowerCase()==b.toLowerCase()})}}).filter("formatDate",function(){return function(a){if(a){var a=new Date(a),b=a.getHours(),c=a.getMinutes(),d=b>=12?"pm":"am";b%=12,b=b?b:12,c=10>c?"0"+c:c;var e=b+":"+c+" "+d;return a.getMonth()+1+"/"+a.getDate()+"/"+a.getFullYear()+"  "+e}return"unknown time"}}).filter("formatDateAsElapsed",["utilService",function(a){return function(b){if(b){var b=new Date(b),c=new Date;return a.datediff(b,c)}return"unknown time"}}]).filter("formatAddress",function(){return function(a){var b=28;return a?a.length>b?a.substring(0,Math.min(b,a.length))+"...":a:"unknown location"}}).controller("decorCtrl",["$scope","$http","$alert","$location","$rootScope","$routeParams","baseUrl","decorsListService","subscriptionService","decorService","decorDataService","toolService","lightService","utilService","vcRecaptchaService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){a.name="decorCtrl scope",a.data=k.getData(),a.app_data=k.getAppData(),a.setDirty=function(b){a.dirty=b},a.setDirty(!1),a.getPrompt=function(){return angular.isUndefined(f.id)?{prompt:"Click to load a picture to decorate on",cycle:!1}:{prompt:"Loading, please wait...",cycle:!0}},a.recaptcha={key:"6Le3FAETAAAAALObaPdsf277KQlhJ2BN1N90sPda",setResponse:function(a){console.info("Response available"),this.response=a},setWidgetId:function(a){console.info("Created widget ID: %s",a),this.widgetId=a}},a.saveDecor=function(){if(!e.currentUser)return a.saveDialog.hide(),a.keepDataInCache=!0,d.path("/login/"),void c({title:"Login required!",content:"Login required before saving decor.",placement:"top-left",type:"danger",duration:3});if(a.keepDataInCache=!1,a.decor_id){a.data.decor.user_id=e.currentUser._id,a.data.decor.last_mod_time=new Date;var b={data:a.data,recaptcha_response:o.getResponse()};h.update({_id:a.decor_id},b).$promise.then(function(b){a.setDirty(!1),a.saveDialog.$promise.then(function(){k.resetData(),a.saveDialog.hide()})},function(b){401==b.status?(a.saveDialog.hide(),d.path("/login/")):403==b.status?(a.saveDialog.hide(),d.path("/"),c({title:"Error occurred while saving!",content:"You can not save a decor designed by somebody else.",placement:"top-left",type:"danger",duration:3})):409==b.status?o.reload(a.recaptcha.widgetId):c({title:"Error occurred while saving!",content:b.data?b.data.message:b,placement:"top-left",type:"danger",duration:3})})}else{a.data.decor.user_id=e.currentUser._id,a.data.decor.create_time=new Date,a.data.decor.last_mod_time=new Date;var b={data:a.data,recaptcha_response:o.getResponse()};new h(b).$save().then(function(b){a.data=b,a.setDirty(!1),a.saveDialog.hide(),k.resetData()},function(b){401==b.status?(a.saveDialog.hide(),d.path("/login/")):409==b.status?o.reload(a.recaptcha.widgetId):c({title:"Error occurred while saving!",content:b.data.message,placement:"top-left",type:"danger",duration:3})})}},a.deleteDecor=function(){a.decor_id&&a.data.$delete(function(){c({title:"Decor removed!",content:"Successfully removed decor from cloud.",placement:"top-right",type:"success",duration:3}),k.resetData(),a.data=k.getData(),d.path("/")})},a.element_config=l.getTool("").current_config.install_supported_defs(a.data.defs),a.initShadowStopColors=function(){if(a.current.decor.line_element_id){var b=d3.select("g[decor_line_id='"+a.current.decor.line_id+"'][decor_line_element_id='"+a.current.decor.line_element_id+"']"),c=a.element_config.rgConfigured.stops,d=m.getLight(b.data()[0].light_type),e=d.getColorDef(d.color);e&&(c[0].color=n.hslStringToRgbString(e.stopcolor1),c[c.length-1].color=n.hslStringToRgbString(e.stopcolor2))}},a.shadowViewFunc=function(){if(a.current.decor.line_element_id){var b=d3.select("g[decor_line_id='"+a.current.decor.line_id+"'][decor_line_element_id='"+a.current.decor.line_element_id+"']"),c=n.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id),d=n.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines[c].elements,"id",a.current.decor.line_element_id);if(a.data.decor.decor_lines[c].elements[d].shadow=angular.copy(a.element_config.rgConfigured),a.decor_line_element_enter_func(a.current.decor.line_id),angular.isDefined(b)){if(b.data.length>0){var e=b.data()[0],f=m.getLight(e.light_type),g=e.shadow.stops,h=b.attr("bulbcolor"),i=f.getColorDef(h);i&&(g[0].color=n.hslStringToRgbString(i.stopcolor1),g[g.length-1].color=n.hslStringToRgbString(i.stopcolor2))}b.call(f.turnon).call(f.flash).call(f.glow).call(f.castshadow).call(f.emitray)}}else if(a.current.decor.line_id){var j=d3.selectAll("g[decor_line_id='"+a.current.decor.line_id+"'].decor_line_element"),c=n.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id);_.forEach(a.data.decor.decor_lines[c].elements,function(b){b.shadow=angular.copy(a.element_config.rgConfigured)}),a.decor_line_element_enter_func(a.current.decor.line_id),j.each(function(){var a=d3.select(this);if(a.data.length>0){var b=a.data()[0],c=m.getLight(b.light_type),d=b.shadow.stops,e=a.attr("bulbcolor"),f=c.getColorDef(e);f&&(d[0].color=n.hslStringToRgbString(f.stopcolor1),d[d.length-1].color=n.hslStringToRgbString(f.stopcolor2))}a.call(c.turnon).call(c.flash).call(c.glow).call(c.castshadow).call(c.emitray)})}},a.init_current=function(){var b;a.current&&(b=_.clone(a.current.operation)),a.current={decor:{},widget:{line_type:"Roof Lighting"},operation:{type:"segment"},animation:{},music:{},instructions:"select one decoration widget above and start decorating!"},b&&(a.current.operation=b),a.selectWidget("roof lighting"),a.selectTool("lineMultiTool")},a.selectWidget=function(b,c){a.current.widget.line_type=b;var d=n.getArrayIndexWithPropertyEqualToIgnoreCase(a.data.widgets,"name",b),e=a.data.widgets[d];if(e)if(e.hasOwnProperty("subcats")&&e.subcats.length>0&&!c&&angular.isUndefined(a.current.widget.line_subtype))a.current.widget.line_subtype=e.subcats[0].name,a.current.widget.line_subtype&&a.selectSubCat(a.current.widget.line_subtype);else if(!angular.isUndefined(a.current.widget.line_subtype)){var f=n.getArrayIndexWithPropertyEqualToIgnoreCase(e.subcats,"name",a.current.widget.line_subtype);angular.isUndefined(f)&&!c&&(a.current.widget.line_subtype=e.subcats.length>0?e.subcats[0].name:void 0,a.selectSubCat(a.current.widget.line_subtype))}var g=j.getDecor(b);a.current.instructions=g?g.instructions:"need to define "+b+" decor service",angular.forEach(a.data.widgets,function(a){a.show_detail=!1,a.name.toLowerCase()==b.toLowerCase()&&(a.show_detail=!0)}),a.data.widgets.activeWidget=d,a.$$phase||a.$apply()},a.selectSubCat=function(b){var c,d;if(b){for(var e=0;e<a.data.widgets.length;e++){var f=n.getArrayIndexWithPropertyEqualTo(a.data.widgets[e].subcats,"name",b);if(void 0!=f){d=a.data.widgets[e].name,c=a.data.widgets[e].subcats[f].toolname;break}}d&&b&&(a.current.widget.line_type=d,a.current.widget.line_subtype=b,a.selectTool(c?c:"shiningxmaslighttypetool"))}},a.selectTool=function(b){var c=l.getTool(b);c&&c.beforeinvoke(a).invoke().afterinvoke(a)},a.getToolInstructions=function(a){var b=l.getTool(a);return b.instructions},a.getToolIcon=function(b){var c=_.find(a.data.tools,function(a){return a.name==b});return c.icon_toggle?c.icons[1]:c.icons[0]},a.mouseOverDecorLine=function(b){a.svg.select("g[decor_line_id='"+b+"']").selectAll(".click-capture").style("visibility","visible").classed("highlighted",!0)},a.mouseLeaveDecorLine=function(b){a.svg.select("g[decor_line_id='"+b+"']").selectAll(".click-capture").style("visibility","hidden").classed("highlighted",!1)},a.toggleDecorLine=function(b){var c=n.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",b),d=a.svg.select("g[decor_line_id='"+b+"']");null!=d.attr("opacity")&1!=d.attr("opacity")?(d.transition().duration(500).attr("opacity",1),a.data.decor.decor_lines[c].decor_line_visible=!0):(d.transition().duration(500).attr("opacity",0),a.data.decor.decor_lines[c].decor_line_visible=!1)},a.delDecorLine=function(b){for(var c=n.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",b);a.data.decor.decor_lines[c].elements.length>0;)a.data.decor.decor_lines[c].elements.pop();a.decor_line_element_exit_func(b)},a.toolOfMode=function(b){return-1!=b.modes.indexOf(a.mode)},a.toolWithOptions=function(a){return a.options.length>0},a.toolWithoutOptions=function(a){return 0==a.options.length},a.isSubscribed=function(){return a.data.subscribers?-1!==a.data.subscribers.indexOf(e.currentUser._id):!1},a.subscribe=function(){i.subscribe({_id:a.data._id}).success(function(){a.data.subscribers||(a.data.subscribers=[]),a.data.subscribers.push(e.currentUser._id)})},a.unsubscribe=function(){i.unsubscribe({_id:a.data._id}).success(function(){var b=a.data.subscribers.indexOf(e.currentUser._id);a.data.subscribers.splice(b,1)})},a.thumbup=function(){a.thumbed||i.thumbup({_id:a.data._id}).success(function(){a.thumbed=!0,a.data.thumbs||(a.data.thumbs={up:0,down:0}),a.data.thumbs.up++})},a.thumbdown=function(){a.thumbed||i.thumbdown({_id:a.data._id}).success(function(){a.thumbed=!0,a.data.thumbs||(a.data.thumbs={up:0,down:0}),a.data.thumbs.down++})},a.getAddress=function(a){var c={address:a,sensor:!1};return b.get("http://maps.googleapis.com/maps/api/geocode/json",{params:c}).then(function(a){return a.data.results.map(function(a){return{label:a.formatted_address,coords:[a.geometry.location.lng,a.geometry.location.lat]}})})},a.minmaxAd=function(){a.minAdUnderDecor=!a.minAdUnderDecor},a.minmaxAdIcon=function(){return a.minAdUnderDecor?"glyphicon glyphicon-chevron-up":"glyphicon glyphicon-remove"},a.minmaxAdClass=function(){return a.minAdUnderDecor?"ad_decor_min":"ad_decor_max"},a.selectMusic=function(b){if(b){var c=n.getArrayIndexWithPropertyEqualTo(a.app_data.musics,"name",b);c>=0&&(a.data.decor.mediaurl=a.app_data.musics[c].url,a.setDirty(!0),a.current.music.track&&(a.current.music.track.destruct(),a.current.music.track=void 0,a.current.music.playing=!1))}else a.selectTool("loadmediatool2")},a.musicInfo=function(){var b=_.findIndex(a.app_data.musics,function(b){return b.url===a.data.decor.mediaurl});return-1==b?"loaded by "+a.data.decor.designer:a.app_data.musics[b].name+" by "+a.app_data.musics[b].author},a.init_current()}]),angular.module("lightgalaApp").controller("loginCtrl",["$scope","$document","Auth","utilService",function(a,b,c,d){b.bind("keydown",function(b){a.$apply(function(){65==b.keyCode&&b.ctrlKey&&(a.use_auth0=!a.use_auth0)})}),a.login=function(){c.login({email:a.email,password:a.password}).then(function(){c.redirectToAttemptedUrl()},function(){$alert({title:"Logged in failed!",content:"Wrong login credential supplied.",placement:"top-right",type:"danger",duration:3})})},a.login_google=function(){c.login_google("/db2/auth/google").then(function(){c.redirectToAttemptedUrl()},function(){})},a.login_facebook=function(){c.login_facebook("/db2/auth/facebook").then(function(){c.redirectToAttemptedUrl()},function(){})},a.login_twitter=function(){c.login_twitter("/db2/auth/twitter").then(function(){c.redirectToAttemptedUrl()},function(){})},a.login_amazon=function(){c.login_amazon("/db2/auth/amazon")},a.login_instagram=function(){c.login_instagram("/db2/auth/instagram").then(function(){c.redirectToAttemptedUrl()},function(){})},a.login_yahoo=function(){c.login_yahoo("/db2/auth/yahoo").then(function(){c.redirectToAttemptedUrl()},function(){})},a.login_windowslive=function(){c.login_windowslive("/db2/auth/windowslive").then(function(){c.redirectToAttemptedUrl()},function(){})},a.login_linkedin=function(){c.login_linkedin("/db2/auth/linkedin").then(function(){c.redirectToAttemptedUrl()},function(){})},a.login_auth0=function(){c.login_auth0("/db2/auth/auth0").then(function(){c.redirectToAttemptedUrl()},function(){})}}]),angular.module("lightgalaApp").filter("formatNumberWithComma",function(){return function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}}).controller("mainCtrl",["$rootScope","$scope","$location","$routeParams","$alert","decorsListService","utilService","uiGmapGoogleMapApi",function(a,b,c,d,e,f,g,h){d.id&&(b.decor_id_viewed=d.id),b.menus={groups_login:[{group_name:"",group_items:[{item_name:"Decor Stars",icon:"glyphicon glyphicon-star",features:[{feature_name:"Daves Landscape",criteria:"Dave Rykbost",criteria_type:"has_keyword",no_user_limit:!0,decors:[]},{feature_name:"Mike's Landscape Lighting",criteria:"Mike Brown",criteria_type:"has_keyword",no_user_limit:!0,decors:[]},{feature_name:"Premium Lighting",criteria:"Emma Wang",criteria_type:"has_keyword",no_user_limit:!0,decors:[]}]},{item_name:"Most Popular",icon:"glyphicon glyphicon-heart",features:[{feature_name:"My Favorites",criteria:function(){return".gt('thumbs.up',100)"},criteria_type:"mongoose_query",decors:[]}]},{item_name:"Decors Nearby",icon:"glyphicon glyphicon-gift",features:[{feature_name:"Within 50 miles",criteria:function(){return b.decors.length>0?".where('decor.address.coords').near({center: ["+b.decors[0].decor.address.coords[0]+","+b.decors[0].decor.address.coords[1]+"], maxDistance: 50/3959, spherical: true})":""},criteria_type:"mongoose_query",decors:[]}]},{item_name:"My Subscription",icon:"glyphicon glyphicon-check",features:[{feature_name:"My Subscription",criteria:function(){return".where({'subscribers': '"+(a.currentUser?a.currentUser._id:"")+"'})"},criteria_type:"mongoose_query",no_user_limit:!0,decors:[]}]}]},{group_name:"Decoration Pros",group_items:[{item_name:"Browse",icon:"glyphicon glyphicon-leaf"},{item_name:"My Pros",icon:"glyphicon glyphicon-tree-deciduous"},{item_name:"Rate",icon:"glyphicon glyphicon-thumbs-up"}]},{group_name:"",group_items:[{item_name:"Where is lit",icon:"glyphicon glyphicon-globe",templateUrl:"mainrightmap"},{item_name:"Feedback",icon:"glyphicon glyphicon-comment"},{item_name:"Share",icon:"glyphicon glyphicon-share-alt"}]}],groups_nologin:[{group_name:"",group_items:[{item_name:"Decor Stars",icon:"glyphicon glyphicon-star",features:[{feature_name:"Daves Landscape",criteria:"Dave Rykbost",criteria_type:"has_keyword",no_user_limit:!0,decors:[]},{feature_name:"Mike's Landscape Lighting",criteria:"Mike Brown",criteria_type:"has_keyword",no_user_limit:!0,decors:[]},{feature_name:"Premium Lighting",criteria:"Emma Wang",criteria_type:"has_keyword",no_user_limit:!0,decors:[]}]},{item_name:"Most Popular",icon:"glyphicon glyphicon-heart",features:[{feature_name:"My Favorites",criteria:function(){return".gt('thumbs.up',100)"},criteria_type:"mongoose_query",no_user_limit:!0,decors:[]}]},{item_name:"Newly Added",icon:"glyphicon glyphicon-circle-arrow-up",features:[{feature_name:"Today",criteria:".gt('decor.last_mod_time',(new Date()).setDate((new Date()).getDate()-1))",criteria_type:"mongoose_query",no_user_limit:!0,decors:[]},{feature_name:"Past Week",criteria:".gt('decor.last_mod_time',(new Date()).setDate((new Date()).getDate()-7)).lt('decor.last_mod_time',(new Date()).setDate((new Date()).getDate()-1))",criteria_type:"mongoose_query",no_user_limit:!0,decors:[]}]}]},{group_name:"Decoration Pros",group_items:[{item_name:"Browse",icon:"glyphicon glyphicon-leaf"},{item_name:"My Pros",icon:"glyphicon glyphicon-tree-deciduous"},{item_name:"Rate",icon:"glyphicon glyphicon-thumbs-up"}]},{group_name:"",group_items:[{item_name:"Where is lit",icon:"glyphicon glyphicon-globe",templateUrl:"mainrightmap"},{item_name:"Feedback",icon:"glyphicon glyphicon-comment"},{item_name:"Share",icon:"glyphicon glyphicon-share-alt"}]}]},a.currentUser?b.menu_groups=b.menus.groups_login:b.menu_groups=b.menus.groups_nologin,b.selectItem=function(a){for(var c=0;c<b.menu_groups.length;c++){_.forEach(b.menu_groups[c].group_items,function(a){a.status=""});var d=g.getArrayIndexWithPropertyEqualTo(b.menu_groups[c].group_items,"item_name",a);d>=0&&(b.menu_groups[c].group_items[d].status="selected",b.menu_groups[c].group_items[d].hasOwnProperty("features")&&(b.main_right_partial="mainrightshow",b.decors_featured=b.menu_groups[c].group_items[d].features),b.menu_groups[c].group_items[d].hasOwnProperty("templateUrl")&&(b.main_right_partial=b.menu_groups[c].group_items[d].templateUrl))}},b.decors_featured=[],b.selectItem("Decor Stars"),b.decors=[],b.currentPage=-1,b.loadTimes=0,b.maxLoadTimes=10,b.excludeCurrentViewedDecor=function(a){return a._id!=b.decor_id_viewed},b.allowLoadMore=function(){return b.loadTimes<b.maxLoadTimes},b.loadMoreDecors=function(){$("#loadmoredecor").prop("disabled",!0),f.query({criteria:b.criteria,criteria_type:"has_keyword",page:b.currentPage+1}).$promise.then(function(a){b.decors=b.decors.concat(a[0].decors),b.currentPage=parseInt(a[0].page),a[0].lastpage?b.loadTimes=b.maxLoadTimes:b.loadTimes+=1,$("#loadmoredecor").prop("disabled",!1),h.then(function(a){var c=b.decors;c.length>0&&c[0].decor.address.coords&&(b.map={center:{latitude:c[0].decor.address.coords[1],longitude:c[0].decor.address.coords[0]},zoom:8,bounds:{northeast:{latitude:_.max(c,function(a){return a.decor.address.coords[1]}).decor.address.coords[1],longitude:_.max(c,function(a){return a.decor.address.coords[0]}).decor.address.coords[0]},southwest:{latitude:_.min(c,function(a){return a.decor.address.coords[1]}).decor.address.coords[1],longitude:_.min(c,function(a){return a.decor.address.coords[0]}).decor.address.coords[0]}},markers:_.pluck(c,function(a){return{id:c.indexOf(a),decor_id:a._id,title:a.decor.title,coords:{latitude:a.decor.address.coords[1],longitude:a.decor.address.coords[0]},options:{icon:{url:"/img/maplight.png",scaledSize:new google.maps.Size(28,28)}}}}),windowOptions:{visible:!1},onClick:function(){this.windowOptions.visible=!this.windowOptions.visible},closeClick:function(){this.windowOptions.visible=!1}})})},function(a){$("#loadmoredecor").prop("disabled",!1),e({title:"Error occurred while retrieving decor!",content:a.data.message,placement:"top-right",type:"danger",duration:3})})},b.loadMoreDecors(),b.$on("searchcriteriachanged",function(a,c){b.criteria=c.criteria}),b.$on("decorslistchanged",function(a,c){b.decors=c.decors[0].decors,b.loadTimes=0,b.currentPage=0}),b.myInterval=15e3,b.numDecorsEachFrame=4,b.decors_watch_list=[],b.prepare_decors_featured=function(){_.forEach(b.decors_watch_list,function(a){a()}),b.decors_watch_list=[];for(var a=function(a){b.decors_watch_list.push(b.$watch(function(){return a.decors},function(c){var d,e=[];for(d=0;d<a.decors.length;d+=b.numDecorsEachFrame){for(var f=[],g=0;g<b.numDecorsEachFrame;g++)a.decors[d+g]&&f.push(a.decors[d+g]);e.push(f)}a.groupedDecors=e},!0))},c=0;c<b.decors_featured.length;c++)f.query({criteria:b.decors_featured[c].criteria instanceof Function?b.decors_featured[c].criteria():b.decors_featured[c].criteria,criteria_type:b.decors_featured[c].criteria_type,no_user_limit:b.decors_featured[c].no_user_limit,page:0}).$promise.then(function(c){return function(d){b.decors_featured[c].decors=d[0].decors,b.decors_featured[c].page=parseInt(d[0].page),a(b.decors_featured[c])}}(c),function(a){})},b.$watch(function(){return _.map(b.decors_featured,function(a){return a.feature_name})},b.prepare_decors_featured,!0)}]),angular.module("lightgalaApp").controller("navbarCtrl",["$http","$rootScope","$scope","decorsListService","Auth",function(a,b,c,d,e){c.search_criteria="",c.logout=function(){e.logout()},c.search=function(){var a={criteria:c.search_criteria,criteria_type:"has_keyword",page:0};d.query(a).$promise.then(function(c){b.$broadcast("searchcriteriachanged",{criteria:a.criteria}),b.$broadcast("decorslistchanged",{decors:c})})}}]),angular.module("lightgalaApp").controller("signupCtrl",["$scope","Auth",function(a,b){a.signup=function(){b.signup({email:a.email,password:a.password})}}]),angular.module("lightgalaApp").value("redirectToUrlAfterLogin",{url:"/"}).factory("Auth",["$http","$location","$rootScope","$cookieStore","$alert","$window","redirectToUrlAfterLogin",function(a,b,c,d,e,f,g){return c.currentUser=d.get("user"),d.remove("user"),{isLoggedIn:function(){return c.currentUser},login_google:function(){f.location.href="/db2/auth/google"},login_facebook:function(){f.location.href="/db2/auth/facebook"},login_twitter:function(){f.location.href="/db2/auth/twitter"},login_amazon:function(){f.location.href="https://lightgala.com:8000/db2/auth/amazon"},login_instagram:function(){f.location.href="https://lightgala.com:8000/db2/auth/instagram"},login_yahoo:function(){f.location.href="/db2/auth/yahoo"},login_windowslive:function(){f.location.href="/db2/auth/windowslive"},login_linkedin:function(){f.location.href="/db2/auth/linkedin"},login_auth0:function(){f.location.href="/db2/auth/auth0"},login:function(d){return a.post("/db2/api/login",d).success(function(a){c.currentUser=a,b.path("/"),e({title:"Logged In!",content:"You can now edit and save the lighting you created.",placement:"top-right",type:"success",duration:3})}).error(function(){e({title:"Error!",content:"Invalid username or password.",placement:"top-right",type:"danger",duration:3})})},signup:function(c){return a.post("/db2/api/signup",c).success(function(){b.path("/login"),e({title:"Congratulations!",content:"Your account has been created",placement:"top-right",type:"success",duration:3})}).error(function(a){e({title:"Error!",content:a.data,placement:"top-right",type:"danger",duration:3})})},logout:function(){return a.get("/db2/api/logout").success(function(){c.currentUser=null,d.remove("user"),b.path("/"),e({content:"You have been logged out.",placement:"top-right",type:"info",duration:3})})},saveAttemptedUrl:function(){"/login"!=b.path().toLowerCase()&&(g.url=b.path())},redirectToAttemptedUrl:function(){b.path(g.url)}}}]),angular.module("d3",[]).factory("d3Service",["$document","$q","$rootScope",function(a,b,c){for(var d=[b.defer()],e=["/js/lib/d3.js"],f=[],g=a[0].getElementsByTagName("head")[0],h=0;h<e.length;h++){f[h]=function(){var a=h;return function(){c.$apply(function(){d[a].resolve(window.d3)})}}();var i=a[0].createElement("script");i.type="text/javascript",i.async=!0,i.src=e[h],i.onreadystatechange=function(){"complete"==this.readyState&&f[h]()},i.onload=f[h],g.appendChild(i)}return{desc:function(){return"d3service"},d3:function(){return b.all([d[0].promise]).then(function(a){var b=a[0];return b.selection.prototype.moveToBack=function(){return this.each(function(){this.parentNode.insertBefore(this,this.parentNode.firstChild)})},b.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.append(this)})},b.selection.prototype.size=function(){var a=0;return this.each(function(){++a}),a},b.selection.prototype.maxSegment=function(){var a=0;return this.each(function(){var c=parseInt(b.select(this).attr("segment"));c>a&&(a=c)}),a},b.selection.prototype.maxGroup=function(){var a=0;return this.each(function(){var c=parseInt(b.select(this).attr("group"));c>a&&(a=c)}),a},b.selection.prototype.cloneTo=function(a,c){var d=this.node().attributes,e=d.length,f=this.property("nodeName"),g=a.append(f);c&&g.attr("id",this.attr("id")+"-"+c);for(var h=0;e>h;h++)"id"!=d[h].nodeName&&g.attr(d[h].name,d[h].value);for(var i=0;i<this.node().children.length;i++)b.select(this.node().children[i]).cloneTo(g,null);return g},b})}}}]),angular.module("lightgalaApp").factory("decorDataService",function(){var a={decor:{views:0,decor_width:941,decor_aspect_ratio:.65,decor_lines:[]},widgets:[{id:1,name:"Windows/Features",subcats:[],instructions:""},{id:2,name:"Daytime Decor",subcats:[{name:"Garland",toolname:"fancygarlandimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Fancy Wreath",toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Wreath 24"',toolname:"24inchwreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Wreath 30"',toolname:"30inchwreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Wreath 36"',toolname:"36inchwreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Wreath 48"',toolname:"48inchwreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Wreath 60"',toolname:"60inchwreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Wreath 24" Battery w/ Picks',toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Bows 12"',toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Bows 18"',toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Bow 24"',toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Bows structural 24"',toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Bows structural 36"',toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:'Sprays 24"',toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Baskets",toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Pre lit Tree",toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Decor Mesh",toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Mixed grn/bry/pine cone Picks",toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Bulbs",toolname:"fancywreathimagetool",price:1.2,icon:"glyphicon-tree-conifer"}],instructions:""},{id:3,name:"Roof Lighting",subcats:[{name:"Fascia",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Ridges",price:1.2,icon:"glyphicon-tree-conifer"}],instructions:""},{id:4,name:"Tree Lighting",subcats:[{name:"Canopy w/ C-9",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Trunk Wrap",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Branch Wrap",price:1.2,icon:"glyphicon-tree-conifer"},{name:"Canopy w/ C-9 Evergreen",price:1.2,icon:"glyphicon-tree-conifer"}],instructions:""},{id:5,name:"Ground Lighting",subcats:[{name:"",price:null,icon:"glyphicon-tree-conifer"},{name:"Stakes",price:1.2,icon:"glyphicon-tree-conifer"}],instructions:""},{id:6,name:"Shrubs",subcats:[],instructions:""},{id:7,name:"Timers",subcats:[{name:"Water proof boxes",price:1.2,icon:"glyphicon-tree-conifer"}],instructions:""}],tools:[{id:0,name:"shiningxmaslighttypetool",icons:["icon-shiningxmaslight"],options:[],modes:["edit"]},{id:1,name:"basicxmaslighttypetool",icons:["icon-basicxmaslight"],options:[],modes:["edit"]},{id:2,name:"basicgroundlighttypetool",icons:["icon-basicgroundlight"],options:[],modes:["edit"]},{id:3,name:"sizeuptool",icons:["icon-expand"],options:[],modes:["edit"]},{id:4,name:"sizedowntool",icons:["icon-contract"],options:[],modes:["edit"]},{id:4.5,name:"shadowsizeuptool",icons:["icon-shadowup"],options:[],modes:["edit"]},{id:4.6,name:"shadowsizedowntool",icons:["icon-shadowdown"],options:[],modes:["edit"]},{id:5,name:"gapuptool",icons:["icon-expand2"],options:[],modes:["edit"]},{id:6,name:"gapdowntool",icons:["icon-contract2"],options:[],modes:["edit"]},{id:6.1,name:"setsizeuptool",icons:["icon-setsizeup"],options:[],modes:["edit"]},{id:6.2,name:"setsizedowntool",icons:["icon-setsizedown"],options:[],modes:["edit"]},{id:7,name:"rotatetool",icons:["icon-sharable"],options:[{name:"rotatelefttool",icon:"icon-undo"},{name:"rotaterighttool",icon:"icon-redo"},{name:"rotaterandomtool",icon:"icon-shuffle"}],modes:["edit"]},{id:11,name:"lineonetool",icons:["icon-dot"],options:[],modes:["edit"]},{id:12,name:"linemultitool",icons:["icon-ellipsis"],options:[],modes:["edit"]},{id:13,name:"polymultitool",icons:["icon-polymulti"],options:[],modes:["edit"]},{id:14,name:"measuretool",icons:["icon-measurement-tape"],options:[],modes:["edit"]},{id:15,name:"animatestarttool",icons:["glyphicon glyphicon-play","glyphicon glyphicon-pause"],options:[],modes:["edit","play"]},{id:16,name:"nighttool",icons:["icon-moon","icon-sun"],options:[],modes:["edit","play"]},{id:17,name:"musictool",icons:["icon-music","icon-pause"],options:[],modes:["donotshow"]},{id:17.5,name:"volumeonofftool",icons:["glyphicon glyphicon-volume-off","glyphicon glyphicon-volume-up"],options:[],modes:["edit","play"]},{id:18,name:"colorchoosertool",icons:["icon-palette"],options:[{name:"yellowcolortool",icon:"icon-danielbruce icon-yellow"},{name:"orangecolortool",icon:"icon-danielbruce icon-orange"},{name:"bluecolortool",icon:"icon-danielbruce icon-blue"},{name:"redcolortool",icon:"icon-danielbruce icon-red"},{name:"greencolortool",icon:"icon-danielbruce icon-green"},{name:"purplecolortool",icon:"icon-danielbruce icon-purple"},{name:"whitecolortool",icon:"icon-danielbruce icon-white"},{name:"randomcolortool",icon:"icon-danielbruce icon-randomcolor"},{name:"rgbcolortool",icon:"icon-danielbruce icon-rgbcolor"}],modes:["edit"]},{id:19,name:"weathertool",icons:["icon-soundcloud"],options:[{name:"snowtool",icon:"icon-pawn"},{name:"raintool",icon:"icon-droplets"},{name:"sunnytool",icon:"icon-sun"}],modes:["edit","play"]},{id:21,name:"savetool",icons:["icon-disk"],options:[],modes:["edit"]},{id:22,name:"deletetool",icons:["glyphicon glyphicon-trash"],options:[],modes:["edit"]},{id:23,name:"cameratool",icons:["icon-camera"],options:[],modes:["edit"]},{id:24,name:"loadmediatool",icons:["icon-music"],options:[],modes:["edit"]},{id:25,name:"exittool",icons:["icon-exit"],options:[],modes:["edit"]}],defs:[{type:"radialGradient",desc:"definitions of supported colors used in lighting effects rendered as radial gradient",attributes:[{id:"lightflash-blue",colorname:"blue",stopcolor1:"hsl(200, 99%, 23%)",stopcolor2:"hsl(200, 99%, 63%)",dur:"1.8s",begin:"0s",animate:!0},{id:"lightflash-red",colorname:"red",stopcolor1:"hsl(6, 63%, 16%)",stopcolor2:"hsl(6, 63%, 56%)",dur:"1.25s",begin:"0s",animate:!0},{id:"lightflash-yellow",colorname:"yellow",stopcolor1:"hsl(48, 89%, 20%)",stopcolor2:"hsl(48, 89%, 70%)",dur:"1.25s",begin:"0s",animate:!0},{id:"lightflash-orange",colorname:"orange",stopcolor1:"hsl(28, 90%, 22%)",
stopcolor2:"hsl(28, 90%, 62%)",dur:"1.75s",begin:"0s",animate:!0},{id:"lightflash-green",colorname:"green",stopcolor1:"hsl(145, 83%, 24%)",stopcolor2:"hsl(145, 83%, 66%)",dur:"1.5s",begin:"0s",animate:!0},{id:"lightflash-purple",colorname:"purple",stopcolor1:"hsl(282, 100%, 21%)",stopcolor2:"hsl(282, 100%, 71%)",dur:"1.8s",begin:"0s",animate:!0},{id:"lightflash-white",colorname:"white",stopcolor1:"hsl(0, 0%, 43%)",stopcolor2:"hsl(0, 100%, 100%)",dur:"1.9s",begin:"0s",animate:!0},{id:"lightflash-rgb",colorname:"rgb",stopcolor1:"hsl(6, 63%, 56%)",stopcolor2:"hsl(200, 99%, 63%)",dur:"1s",begin:"0s",animate:!0}]}],animations:[],links:[{id:1,name:"map"},{id:2,name:"pic2"}]},b={musics:[{name:"Christmas Morning",author:"Paul Gentry",url:"/img/PaulGentry_ChristmasMorning.mp3"},{name:"The Shepherds Song",author:"Paul Gentry",url:"/img/PaulGentry_TheShepherdsSong.mp3"},{name:"The Christmas Song",author:"",url:"/img/TheChristmasSong.wav"},{name:"I Wonder As I Wander",author:"Richard Souther",url:"/img/RichardSouther_IWonderAsIWander.mp3"},{name:"Joy To The World",author:"Louis Landon",url:"/img/LouisLandon_JoyToTheWorld.mp3"},{name:"Silent Night",author:"Michele McLaughlin",url:"/img/MicheleMcLaughlin_SilentNight.mp3"},{name:"What Child Is This",author:"Denny Jiosa",url:"/img/DennyJiosa_WhatChildIsThis.mp3"},{name:"The First Noel",author:"Michael Dulin",url:"/img/MichaelDulin_TheFirstNoel.mp3"},{name:"Angels We Have Heard On High",author:"Solomon Keal",url:"/img/AngelsWeHaveHeardOnHigh_SolomonKeal.mp3"},{name:"Away In A Manger",author:"Joe Bongiorno",url:"/img/JoeBongiorno_AwayInAManger.mp3"},{name:"Carol Of The Bells",author:"Doug Hammer",url:"/img/DougHammer_CarolOfTheBells.mp3"},{name:"O Little Town Of Bethlehem",author:"Jennifer Haines",url:"/img/JenniferHaines_OLittleTownOfBethlehem.mp3"}]};return b.widgets=angular.copy(a).widgets,b.tools=angular.copy(a).tools,b.defs=angular.copy(a).defs,{data:angular.copy(a),app_data:b,getData:function(){return this.data},setData:function(a){this.data=a},resetData:function(){this.data=angular.copy(a)},resetAppData:function(){b.widgets=angular.copy(a).widgets,b.tools=angular.copy(a).tools},getAppData:function(){return this.app_data}}}),angular.module("lightgalaApp").factory("decorsListService",["$resource",function(a){return a("/db2/api/decors/:_id",{_id:"@_id"},{update:{method:"PUT"}})}]),angular.module("lightgalaApp").factory("decorService",["$window","lightService","lightAnimService","utilService",function(a,b,c,d){var e={elementMakeFunc:function(){var a=this;return function(){var b=Array.prototype.slice.call(arguments,0),c=a.elementConfig.uselight;c.makeLightFunc.apply(c,b)}},elementUpdateFunc:function(){var a=this;return function(){var b=Array.prototype.slice.call(arguments,0),c=a.elementConfig.uselight;c.updateLightFunc.apply(c,b)}},config:function(a){var c=this;for(key in a)a.hasOwnProperty(key)&&(c.elementConfig[key]=a[key]);return"light_type"in c.elementConfig&&(c.elementConfig.uselight=b.getLight(c.elementConfig.light_type).initColors(a.defs)),"color"in c.elementConfig&&"uselight"in c.elementConfig&&(c.elementConfig.uselight.color=c.elementConfig.color),"scale_factor"in c.elementConfig&&"uselight"in c.elementConfig&&(c.elementConfig.uselight.scaleFactor=c.elementConfig.scale_factor),this},makeOneElementAt:function(a,b,c,e,f,g,h){var i=a.length+1;return{id:d.uniqueId(i),light_type:c.uselight.light_type,light_subtype:c.uselight.light_subtype,light_unbreakable:c.uselight.light_unbreakable?c.uselight.light_unbreakable:!1,light_unlightable:c.uselight.light_unlightable?c.uselight.light_unlightable:!1,light_unflashable:c.uselight.light_unflashable?c.uselight.light_unflashable:!1,color:c.uselight.color,scale_factor:c.uselight.scaleFactor,rotate_degree:c.rotate_degree,x:b.x,y:b.y,w:8,h:10,segment:f,set:g,group:h,tag:e,scale_factor_shadow:c.scale_factor_shadow,shadow:angular.copy(c.rgConfigured)}},convertElementToConfig:function(a){return{uselight:{light_type:a.light_type,light_subtype:a.light_subtype,light_unbreakable:a.light_unbreakable,light_unlightable:a.light_unlightable,light_unflashable:a.light_unflashable,color:a.color,scaleFactor:a.scale_factor},rotate_degree:a.rotate_degree,scale_factor:a.scale_factor,scale_factor_shadow:a.scale_factor_shadow,rgConfigured:angular.copy(a.shadow)}},updateElementWithConfig:function(a,b){for(key in b)b.hasOwnProperty(key)&a.hasOwnProperty(key)&&(a[key]=b[key])},distElements:function(a,b){return Math.round(Math.sqrt(Math.pow(b.y-a.y,2)+Math.pow(b.x-a.x,2)))},operationType:function(a){return a&&a.length>1?"set":"segment"},lineOne:function(a,b,c,d,e,f){var g=0,h=0,i=0,j=this.operationType(f);if(f&&e){if("set"==j){var k=_.pluck(a,function(a){return a.set});h=_.max(k)+1;var l=_.pluck(a,function(a){return a.group});i=_.max(l)+1}else h=e?e.set:0,i=e?e.group:0,g=e.segment+1;for(var m=0;m<f.length;m++)if(!c){var n=f[m],o="set"==j?this.convertElementToConfig(n):d,p="set"==j?[(n.x-e.x)*d.set_scale_factor,(n.y-e.y)*d.set_scale_factor]:[n.x-e.x,n.y-e.y],q={x:b.x+p[0],y:b.y+p[1]};g="set"==j?n.segment:g,a.push(this.makeOneElementAt(a,q,o,"original",g,h,i))}}else c||a.push(this.makeOneElementAt(a,b,d,"original",g,h,i))},lineMulti:function(a,b,c,d,e,f){var g=0,h=0,i=0,j=0,k=0,l=this.operationType(f);if(f&&e){if("set"==l){var m=_.pluck(a,function(a){return a.set});h=_.max(m);var n=_.pluck(a,function(a){return a.group});j=_.max(n)}else h=e?e.set:0,j=e?e.group:0,g=e.segment+1;for(var o=0,p=0,q=0,r=0;r<f.length;r++){var s=f[r],g="set"==l?s.segment:g,t=s.tag,u="set"==l?[(s.x-e.x)*d.set_scale_factor,(s.y-e.y)*d.set_scale_factor]:[s.x-e.x,s.y-e.y],v={x:b.x+u[0],y:b.y+u[1]};o=0==o?Math.round(this.distElements(s,v)/d.gap):o,p=(v.x-s.x)/o,q=(v.y-s.y)/o;var w=_.findIndex(a,function(a){return _.isEqual(a,e)});a[w].segment=g;var x="set"==l?this.convertElementToConfig(s):d;c&&(o-=1);for(var y=0;o>y;y++){t=s.tag,i="set"==l?h+1:h,k="set"==l?j+y+1:j;var z={x:s.x+(y+1)*p,y:s.y+(y+1)*q};t=y!=o-1?"interpolated":"set"==l?t:"original",a.push(this.makeOneElementAt(a,z,x,t,g,i,k))}}}else{var A=a.length>0?a[a.length-1]:void 0,o=A?Math.round(this.distElements(A,b)/d.gap):1,p=A?(b.x-A.x)/o:b.x,q=A?(b.y-A.y)/o:b.y,t="interpolated";g=A?A.segment+1:g,A&&(A.segment=g),c&&(o-=1);for(var r=0;o>r;r++){A=a.length>0?a[a.length-1]:void 0;var z=A?{x:A.x+p,y:A.y+q}:{x:p,y:q};c||r!=o-1||(t="original"),a.push(this.makeOneElementAt(a,z,d,t,g,h,k))}}},polyMulti:function(a,b,c,e,f,g){var h=function(a,b,c,e,f,g){this.lineMulti(a,b,c,e,f,g),_.forEach(a,function(a){a.segment=0}),g=_.filter(g,function(a){return _.isObject(a)});var h=_.max(_.pluck(a,function(a){return a.set})),i=f?f.set:h,j=_.max(_.pluck(a,function(a){return a.group})),k=f?f.group:j,l=_.filter(a,function(a){return"original"==a.tag&&a.set==i&&a.group==k});d.removeArrayElementSatisfy(a,function(a){return"interpolated"==a.tag&&a.set==i&&a.group==k});for(var m=d.maxmin(l,function(a){return a.x}),n=d.maxmin(l,function(a){return a.y}),o={x:m.min,y:n.min},p={x:m.max,y:n.min},q={x:m.min,y:n.max},r=({x:m.max,y:n.max},Math.round(this.distElements(o,p)/e.gap)),s=Math.round(this.distElements(o,q)/e.gap),t=(p.x-o.x)/r,u=(q.y-o.y)/s,v=0,w=0,x="interpolated",y=0,z=0;s>z;z++){v=d.isOdd(z)?-e.gap/2:0;for(var A=0;r>A;A++){w=(Math.random()-1)*e.gap;var B={x:o.x+(A+1)*t+v,y:o.y+(z+1)*u+w};this.pointInPolygon(B,l)&&a.push(this.makeOneElementAt(a,B,e,x,y,i,k))}}};"set"==this.operationType(g)?this.lineMulti(a,b,c,e,f,g):h.call(this,a,b,c,e,f,g)},pointInPolygon:function(a,b){for(var c={x:a.x,y:-a.y},d=[],e=0;e<b.length;e++)"original"==b[e].tag&&d.push({x:b[e].x,y:-b[e].y});for(var f,g,h=d.length,i=!1,f=0,g=h-1;h>f;g=f++)d[f].y>c.y!=d[g].y>c.y&&c.x<(d[g].x-d[f].x)*(c.y-d[f].y)/(d[g].y-d[f].y)+d[f].x&&(i=!i);return i},pointInPolygon2:function(a,b){for(var c,e,f=$.grep(b,function(a){return"original"==a.tag}),g=!1,h=d.maxmin(f,function(a){return a.y}).max+10,j={x:a.x,y:h-a.y},k=[],l=0;l<f.length;l++)k.push({x:f[l].x,y:h-f[l].y});var m=k.length,n=m-1;for(i=0;i<m;i++)(k[i].y<j.y&&k[n].y>=j.y||k[n].y<j.y&&k[i].y>=j.y)&&(k[i].x<=j.x||k[n].x<=j.x)&&(c=Math.abs((k[n].y-k[i].y)/(k[n].x-k[i].x)),e=Math.abs((j.y-k[i].y)/(j.x-k[i].x)),c>e&&(g=!g)),n=i;return g},decor:function(){var a,b=Array.prototype.slice.call(arguments,0);for(i in b)if(angular.isObject(b[i])&&"decor_method"in b[i]){a=b[i].decor_method;break}b.length>1&&a&&(decor_args=b.slice(0),this[a].apply(this,decor_args))},decor_line_start_at:function(a,b){a.setDirty(!0);var e=a.current.operation.type;!1 in a.data.decor&&(a.data.decor.decor_lines=[]);var f=a.current.decor?a.current.decor.line_id:void 0,g=$.grep(a.data.decor.decor_lines,function(b){return b.decor_line_type==a.current.widget.line_type}).length;if(void 0==f){if("max_lines"in this.elementConfig&&!(g<this.elementConfig.max_lines))return console.log("max line reached, do nothing"),this;f=a.data.decor.decor_lines.length+1;var h=d.uniqueId(f);a.data.decor.decor_lines.push({decor_line_id:h,decor_line_type:a.current.widget.line_type,decor_line_subtype:a.current.widget.line_subtype,decor_line_visible:!0,decor_line_animtype:this.elementConfig.anim_type,elements:[]});var i=d.uniqueId(1);a.current.decor={line_id:h,line_element_id:i}}else{var f=d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id),j=a.data.decor.decor_lines[f].elements.length;if("max_elements"in this.elementConfig&&j>=this.elementConfig.max_elements)return console.log("max elements reached, do nothing"),this}if(f=d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id),b){var k=this.decor_line_hinge_element(a),l=this.decor_line_from_elements(a);this.decor(a.data.decor.decor_lines[f].elements,{x:a.xScale_reverse(b[0]),y:a.yScale_reverse(b[1])},!1,k,l);var m=a.data.decor.decor_lines[f].elements[a.data.decor.decor_lines[f].elements.length-1];a.current.decor.line_element_id=m.id;var n=_.unique(_.map(a.data.decor.decor_lines[f].elements,function(a){return{segment:a.segment,set:a.set,color:a.color}})),o=this;_.forEach(n,function(b){c.getAnim().initialize(a.data.animations,a.current.decor.line_id,b.segment,b.set,b.color,o.elementConfig.anim_start_second,a.data.defs[0].attributes)})}return a.$$phase||a.$apply(),a.decor_line_element_update_func(a.current.decor.line_id),a.decor_line_element_enter_func(a.current.decor.line_id),a.decor_line_element_exit_func(a.current.decor.line_id),"set"==e&&(a.current.decor.line_element_id=null),a.initShadowStopColors(),this},decor_line_trace_at:function(a,b){if("max_elements"in this.elementConfig&&a.data.decor.decor_lines[c].elements.length>=this.elementConfig.max_elements);else{if(this.elementConfig.keep_trace||a.delTraceLine(a.current.decor.line_id),a.current.decor.line_id&&!a.current.decor.line_element_id){var c=d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id),e=_.max(_.pluck(a.data.decor.decor_lines[c].elements,function(a){return a.group})),f=_.map(_.filter(a.data.decor.decor_lines[c].elements,function(a){return a.group==e}),function(a){return[a.x,a.y]});a.showTraceLinesFromPointForPoints(b,f)}a.current.decor.line_id&&a.current.decor.line_element_id&&a.showTraceLineFromPoint(b)}return this},decor_line_end_at:function(a,b){var e=d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id),f=a.svg.select("g[decor_line_id='"+a.current.decor.line_id+"']").selectAll(".decor_line_element").maxGroup(),g=a.svg.select("g[decor_line_id='"+a.current.decor.line_id+"']").selectAll(".decor_line_element").maxSegment()+1,h=b?parseInt(b[2]):void 0,i=b?parseInt(b[3]):void 0;if(angular.isNumber(h)&&h!=g-1&&i==f){var j={x:a.xScale_reverse(b[0]),y:a.yScale_reverse(b[1])},k=null,l=[];"set"==a.current.operation.type&&(k=this.decor_line_hinge_element(a),l=this.decor_line_from_elements(a)),this.decor(a.data.decor.decor_lines[e].elements,j,!0,k,l);var m=a.data.decor.decor_lines[e].elements[a.data.decor.decor_lines[e].elements.length-1],h=m.segment,n=m.set;c.getAnim().initialize(a.data.animations,a.current.decor.line_id,h,n,this.elementConfig.color,this.elementConfig.anim_start_second,a.data.defs[0].attributes),a.decor_line_element_enter_func(a.current.decor.line_id),a.decor_line_element_exit_func(a.current.decor.line_id)}return this.elementConfig.keep_trace||a.delTraceLine(a.current.decor.line_id),a.current.decor={},a.current.operation.type=void 0,this},decor_line_hinge_element:function(a){var b;if(!a.current.decor.line_id)return void 0;var c=d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id);return b=a.data.decor.decor_lines[c].elements[a.data.decor.decor_lines[c].elements.length-1]},decor_line_from_elements:function(a){var b;if(!a.current.decor.line_id)return void 0;var c=d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id),e=_.max(_.pluck(a.data.decor.decor_lines[c].elements,function(a){return a.group}));if(a.current.decor.line_element_id){d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines[c].elements,"id",a.current.decor.line_element_id);b=[a.data.decor.decor_lines[c].elements[a.data.decor.decor_lines[c].elements.length-1]]}else b=_.filter(a.data.decor.decor_lines[c].elements,function(a){return a.group==e});return b},decor_line_element_drag:function(b){var c=d3.behavior.drag().on("dragstart",function(){return b.animateStart(!1),d3.event.sourceEvent.stopPropagation(),!1}).on("drag",function(c){if("play"!==b.mode){b.setDirty(!0);var d=d3.event.x,e=d3.event.y,f=c.scale_factor;if(b.dragged=d3.event.dx||d3.event.dy,b.dragged){var g=d3.select(this);return d>=0+f&&d<=b.width-f&&e>=0+f&&e<=b.height-f&&g.attr("x",d).attr("y",e),d>=b.margins.left+f&&d<=b.width-b.margins.right-f&&e>=b.margins.top+f&&e<=b.height-b.margins.bottom-f?(g.attr("transform",function(a){var c=g.select(".outline").node(),f=c.getBBox(),h=b.rScale(a.scale_factor);return"translate("+(d-(f.x+f.width/2)-(f.x+f.width/2)*(h-1))+","+(e-(f.y+f.height/2)-(f.y+f.height/2)*(h-1))+") scale("+h+") rotate("+b.element_config.rotate()+","+(f.x+f.width/2)+","+(f.y+f.height/2)+")"}).style("fill","black").select(".bulb").classed("lit",function(){return b.current.decor?b.current.decor.line_id==g.attr("decor_line_id"):!1}),g.select(".click-capture").style("visibility","hidden"),g.selectAll(":not(.click-capture)").style("visibility","visible"),g.classed("dragging",!0).moveToBack()):(g.attr("transform",function(a){var c=g.select(".outline").node(),f=c.getBBox(),h=b.rScale(1);return"translate("+(d-(f.x+f.width/2)-(f.x+f.width/2)*(h-1))+","+(e-(f.y+f.height/2)-(f.y+f.height/2)*(h-1))+") scale("+h+") rotate("+b.element_config.rotate()+","+(f.x+f.width/2)+","+(f.y+f.height/2)+")"}).select(".click-capture").style("visibility","visible").style("fill","url("+a.location+"#trash)").attr("stroke-opacity",0).select(".bulb").classed("lit",!1),g.selectAll(":not(.click-capture)").style("visibility","hidden")),!1}}}).on("dragend",function(a){var c=d3.select(this),e=c.attr("x"),f=c.attr("y"),g=a.scale_factor,h=void 0,i=d.getArrayIndexWithPropertyEqualTo(b.data.decor.decor_lines,"decor_line_id",c.attr("decor_line_id")),j=d.getArrayIndexWithPropertyEqualTo(b.data.decor.decor_lines[i].elements,"id",c.attr("decor_line_element_id"));return b.dragged=!1,c.classed("dragging",!1),e>=b.margins.left+g&&e<=b.width-b.margins.right-g&&f>=b.margins.top+g&&f<=b.height-b.margins.bottom-g?void 0!=i&&void 0!=j&&(h=b.data.decor.decor_lines[i].elements[j],h.x=parseInt(b.xScale_reverse(e)),h.y=parseInt(b.yScale_reverse(f))):(b.data.decor.decor_lines[i].elements.splice(j,1),b.decor_line_element_exit_func(c.attr("decor_line_id"))),!1});return c}},f=Object.create(e,{instructions:{value:"decorate roof lights and see animations"},decorName:{value:"roof lighting"},elementConfig:{writable:!0,value:{light_type:"shiningXmasLight",color:"random",gap:10,decor_method:"lineMulti"}},decor:{value:function(a,b,c,d,e){this.__proto__.decor(a,b,c,this.elementConfig,d,e)}}}),g=Object.create(e,{instructions:{value:"decorate tree lights and see animations"},decorName:{value:"tree lighting"},elementConfig:{writable:!0,value:{light_type:"basicXmasLight",color:"white",gap:5,decor_method:"lineMulti"}},decor:{value:function(a,b,c,d,e){this.__proto__.decor(a,b,c,this.elementConfig,d,e)}}}),h=Object.create(e,{instructions:{value:"decorate ground lights along lawn and paved road"},decorName:{value:"ground lighting"},elementConfig:{writable:!0,value:{light_type:"basicGroundLight",color:"white",gap:25,decor_method:"lineMulti"}},decor:{value:function(a,b,c,d,e){this.__proto__.decor(a,b,c,this.elementConfig,d,e)}}}),j=Object.create(e,{instructions:{value:"day time decoration of non lightable things"},decorName:{value:"daytime decor"},elementConfig:{writable:!0,value:{light_type:"basicXmasLight",color:"white",gap:25,decor_method:"lineOne"}},decor:{value:function(a,b,c,d,e){this.__proto__.decor(a,b,c,this.elementConfig,d,e)}}}),k=Object.create(e,{instructions:{value:"decorate shrubs with lights and other ornaments"},decorName:{value:"shrubs"},elementConfig:{writable:!0,value:{light_type:"shiningXmasLight",color:"random",gap:10,decor_method:"polyMulti"}},decor:{value:function(a,b,c,d,e){this.__proto__.decor(a,b,c,this.elementConfig,d,e)}}}),l=Object.create(e,{instructions:{value:"scale the picture by measuring the distance on picture"},decorName:{value:"measurementScaling"},elementConfig:{writable:!1,value:Object.create({},{light_type:{writable:!1,value:"measurementTapeEnd"},decor_method:{writable:!1,value:"lineOne"},max_elements:{writable:!1,value:2},max_lines:{writable:!1,value:1},scale_factor:{writable:!1,value:.5},rotate_degree:{writable:!1,value:0},keep_trace:{writable:!1,value:!0}})},decor:{value:function(a,b,c,d,e){this.__proto__.decor(a,b,c,this.elementConfig,d,e)}},decor_line_trace_at:{value:function(a,b){var c=d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id);return c>=0&&("max_elements"in this.elementConfig&&a.data.decor.decor_lines[c].elements.length>=this.elementConfig.max_elements?(a.cancelRuler(a.current.decor.line_id),this.decor_line_end_at(a,b)):a.showRulerFromPoint(a.current.decor.line_id,b)),this}},decor_line_end_at:{value:function(a,b){var c=d.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id);a.data.decor.decor_lines[c].elements.length>1&&(a.data.decor.decor_lines[c].elements[1].y=a.data.decor.decor_lines[c].elements[0].y,a.decor_line_element_update_func(a.current.decor.line_id)),this.__proto__.decor_line_end_at.call(this,a,b),a.init_current()}},decor_line_element_drag:{value:function(b){var c=this,e=d3.behavior.drag().on("drag",function(e){b.dirty=!0;var f=d3.event.x,g=d3.event.y,h=e.scale_factor;if(b.dragged=d3.event.dx||d3.event.dy,b.dragged){var i=d3.select(this),j=i.attr("decor_line_id"),k=i.attr("decor_line_element_id"),l=d.getArrayIndexWithPropertyEqualTo(b.data.decor.decor_lines,"decor_line_id",j),m=d.getArrayIndexWithPropertyEqualTo(b.data.decor.decor_lines[l].elements,"id",k);if(f>=b.margins.left+h&&f<=b.width-b.margins.right-h&&g>=b.margins.top+h&&g<=b.height-b.margins.bottom-h){if(0==m){var n=c.elementConfig.uselight.offset,o=b.svg.select("g.decor g.decor_lines").select("g[decor_line_id='"+j+"']"),p=o.select("g.measurementTape");p.attr("x-start",b.xScale_reverse(f));var q=parseInt(p.attr("ruler_width"));p.attr("transform","translate("+(f+n.x)+","+(g+n.y)+")"),b.data.decor.decor_lines[l].elements[m].x=b.xScale_reverse(f),b.data.decor.decor_lines[l].elements[m].y=b.yScale_reverse(g),b.data.decor.decor_lines[l].elements.length>1&&(b.data.decor.decor_lines[l].elements[m+1].x=b.xScale_reverse(f)+q,b.data.decor.decor_lines[l].elements[m+1].y=b.yScale_reverse(g))}1==m&&(b.extendRulerToPoint(j,[f,g]),g=b.yScale(b.data.decor.decor_lines[l].elements[m].y),b.data.decor.decor_lines[l].elements[m].x=b.xScale_reverse(f),b.data.decor.decor_lines[l].elements[m].y=b.yScale_reverse(g)),b.decor_line_element_update_func(j),i.select(".click-capture").style("visibility","hidden"),i.selectAll(":not(.click-capture)").style("visibility","visible"),i.classed("dragging",!0)}else i.attr("x",f).attr("y",g),i.attr("transform",function(a){var c=i.select(".outline").node(),d=c.getBBox(),e=b.rScale(1);return"translate("+(f-(d.x+d.width/2)-(d.x+d.width/2)*(e-1))+","+(g-(d.y+d.height/2)-(d.y+d.height/2)*(e-1))+") scale("+e+") rotate("+b.element_config.rotate()+","+(d.x+d.width/2)+","+(d.y+d.height/2)+")"}).select(".click-capture").style("visibility","visible").style("fill","url("+a.location+"#trash)").attr("stroke-opacity",0).select(".bulb").classed("lit",!1),i.selectAll(":not(.click-capture)").style("visibility","hidden");return!1}}).on("dragend",function(a){var c=d3.select(this),e=c.attr("x"),f=c.attr("y"),g=a.scale_factor,h=void 0,i=d.getArrayIndexWithPropertyEqualTo(b.data.decor.decor_lines,"decor_line_id",c.attr("decor_line_id")),j=d.getArrayIndexWithPropertyEqualTo(b.data.decor.decor_lines[i].elements,"id",c.attr("decor_line_element_id"));if(b.dragged=!1,c.classed("dragging",!1),e>=b.margins.left+g&&e<=b.width-b.margins.right-g&&f>=b.margins.top+g&&f<=b.height-b.margins.bottom-g)void 0!=i&&void 0!=j&&(h=b.data.decor.decor_lines[i].elements[j],h.x=parseInt(b.xScale_reverse(e)),h.y=parseInt(b.yScale_reverse(f)));else{var k=b.svg.select("g.decor g.decor_lines").select("g[decor_line_id='"+c.attr("decor_line_id")+"']");k.select("g.measurementTape");b.data.decor.decor_lines[i].elements.splice(0,2),b.data.decor.num_inches_per_x_unit=void 0,b.decor_line_element_exit_func(c.attr("decor_line_id"))}return b.init_current(),!1});return e}}});return{decors:[f,g,h,j,k,l],getDecor:function(a){for(var b=0;b<this.decors.length;b++)if(this.decors[b].decorName.toLowerCase()==a.toLowerCase())return this.decors[b];return void 0}}}]),angular.module("lightgalaApp").factory("lightService",["lightSvgsService","lightAnimService","utilService","$window",function(a,b,c,d){var e={getColors:function(a){var b=_.findIndex(a,function(a){return"radialGradient"==a.type});return b>=0?_.pluck(a[b].attributes,function(a){return a.colorname}):void 0},getColorDefs:function(a){var b=_.findIndex(a,function(a){return"radialGradient"==a.type});return b>=0?a[b].attributes:void 0}},f={light_type:"basicImage",initColors:function(a){return this.colors=e.getColors(a),this.color_defs=e.getColorDefs(a),this},makeLightFunc:function(a){var b=this;a.classed(b.light_type+" "+b.__proto__.light_type,!0),a.append("svg:image").attr("class","outline").attr("xlink:href",this.url).attr("width",this.size.width).attr("height",this.size.height).attr("preserveAspectRatio","none")},updateLightFunc:function(a){a.select("image").attr("class","outline").attr("xlink:href",this.url).attr("width",this.size.width).attr("height",this.size.height).attr("preserveAspectRatio","none")}},g={light_type:"basicLight",anim_type:"onandoff",offset:{value:{x:0,y:0}},color:"random",initColors:function(a){return this.colors=e.getColors(a),this.color_defs=e.getColorDefs(a),this},getColor:function(a){var b,c=this.colors?this.colors:["red","blue","yellow","orange","green","white"];return b="random"==a?c[Math.floor(Math.random()*c.length)]:a},getColorDef:function(a){return this.color_defs?_.find(this.color_defs,function(b){return b.colorname==a}):void 0},updateShadowStopsForColor:function(a,b){var d=a.data();if(d.length>0&&d[0].shadow){var e=d[0].shadow.stops,f=this.getColorDef(b);f&&(e[0].color=c.hslStringToRgbString(f.stopcolor1),e[e.length-1].color=c.hslStringToRgbString(f.stopcolor2))}},makeLightFunc:function(b){function c(){var b=a.getSvgByType(e.light_type),c=e.getColor(e.color);return{color:c,outline_path:b.outline_path,outline_style:b.outline_style,outline_fill:b.outline_fill,outline_fillopacity:b.outline_fillopacity,base:b.base,base_style:b.base_style,base_fill:b.base_fill,base_fillopacity:b.base_fillopacity,bulb_path:b.bulb_path,bulb_style:b.bulb_style,bulb_fill:b.bulb_fill,bulb_fillopacity:b.bulb_fillopacity,ray_path:b.ray_path,ray_style:b.ray_style,ray_fill:b.ray_fill,ray_fillopacity:b.ray_fillopacity}}var e=this,f=new c;b.classed(e.light_type+" "+e.__proto__.light_type,!0);var g=b.attr("decor_line_id"),h=b.attr("segment"),i=b.attr("set");b.append("path").attr("class","outline").attr("d",f.outline_path).attr("style",f.outline_style).attr("fill",f.outline_fill).attr("fill-opacity",f.outline_fillopacity),b.append("rect").attr("class","base").attr("x",f.base.x).attr("y",f.base.y).attr("width",f.base.width).attr("height",f.base.height).attr("style",f.base_style).attr("fill",f.base_fill).attr("fill-opacity",f.base_fillopacity),b.append("path").attr("class","bulb").attr("d",f.bulb_path).attr("style",f.bulb_style).attr("bulbcolor",f.color).attr("fill","url("+d.location+"#light-"+f.color+"-"+g+"-"+h+"-"+i+")").attr("fill-opacity",f.bulb_fillopacity),b.append("path").attr("class","ray").attr("d",f.ray_path).attr("style",f.ray_style).attr("fill-opacity",f.ray_fillopacity).attr("fill","url("+d.location+"#light-"+f.color+"-"+g+"-"+h+"-"+i+")");var j=b.select(".outline").node(),k=j.getBBox();return b.append("rect").attr("class","click-capture").style("visibility","hidden").attr("opacity",.8).attr("x",k.x).attr("y",k.y).attr("width",k.width).attr("height",k.height),e.updateShadowStopsForColor(b,f.color),b},updateLightFunc:function(b){function c(){var b=a.getSvgByType(e.light_type),c=e.getColor(e.color);return{color:c,outline_path:b.outline_path,outline_style:b.outline_style,base:b.base,base_style:b.base_style,bulb_path:b.bulb_path,bulb_style:b.bulb_style,ray_path:b.ray_path,ray_style:b.ray_style,ray_fill:b.ray_fill,ray_fillopacity:b.ray_fillopacity}}var e=this,f=b.attr("decor_line_id"),g=b.attr("segment"),h=b.attr("set"),i=new c;b.attr("class",function(){return e.light_type+" "+e.__proto__.light_type}),b.select("path.outline").attr("d",i.outline_path),b.select("rect.base").attr("x",i.base.x).attr("y",i.base.y).attr("width",i.base.width).attr("height",i.base.height),b.select("path.bulb").attr("bulbcolor",i.color).attr("d",i.bulb_path),b.select("path.ray").attr("d",i.ray_path).attr("style",i.ray_style).attr("fill-opacity",i.ray_fillopacity).attr("fill","url("+d.location+"#light-"+i.color+"-"+f+"-"+g+"-"+h+")"),b.call(this.turnoff).call(this.unglow).call(this.uncastshadow).call(this.unemitray);var j=b.select(".outline").node(),k=j.getBBox();return b.select("rect.click-capture").style("visibility","hidden").attr("opacity",.3).attr("x",k.x).attr("y",k.y).attr("width",k.width).attr("height",k.height),e.updateShadowStopsForColor(b,i.color),b},turnon:function(a){var b=a.attr("decor_line_id"),c=a.attr("segment2"),e=a.attr("set");return a.selectAll(".bulb").each(function(){d3.select(this).attr("fill",function(){var a=d3.select(this).attr("bulbcolor");return"url("+d.location+"#lighton-"+a+"-"+b+"-"+c+"-"+e+")"})}),a},turnoff:function(a){var b=a.attr("decor_line_id"),c=a.attr("segment"),e=a.attr("set");return a.selectAll(".bulb").each(function(){d3.select(this).attr("fill",function(){var a=d3.select(this).attr("bulbcolor");return"url("+d.location+"#light-"+a+"-"+b+"-"+c+"-"+e+")"})}),a},flash:function(a){var b=a.attr("decor_line_id"),c=a.attr("segment"),e=a.attr("set");return a.selectAll(".bulb").each(function(){d3.select(this).classed("unflashable")||d3.select(this).attr("fill",function(){var a=d3.select(this).attr("bulbcolor");return"url("+d.location+"#lightflash-"+a+"-"+b+"-"+c+"-"+e+")"})}),a},unflash:function(a){return a.selectAll(".bulb").each(function(){d3.select(this).classed("unflashable")||d3.select(this).attr("fill","")}),a},glow:function(a){return a.attr("filter","url("+d.location+"#lightglow)"),a},unglow:function(a){a.attr("filter","")},emitray:function(a){return a.selectAll(".ray").each(function(){var a=d3.select(d3.select(this).node().parentNode).select(".bulb").attr("fill");d3.select(this).attr("fill",a).attr("ray-fill-opacity",.4);var b=/\(.*\#([^)]+)\)/g,c=b.exec(a),d=d3.select("#"+c[1]).data()[0];if(d){var e=d.config.dur,f=d.config.begin,g=d.config.pattern_code,h=d3.select(this).attr("ray-fill-opacity"),i=d3.select(this).select("animate");null==i.node()&&d3.select(this).append("animate").attr("attributeName","fill-opacity").attr("values",function(){for(var a,b="",c=0;c<g.length;c++)a=String(1==g[c]?h:0),b=b+a+";";return b+a}).attr("keyTimes",function(){for(var a="",b=0==g.length?1:1/g.length,c=0;c<g.length;c++)a=a+c*b+";";return a.length>0?a+"1":"0;1"}).attr("dur",e).attr("begin",f).attr("repeatCount","indefinite")}}),a},unemitray:function(a){return a.selectAll(".ray").each(function(){d3.select(this).attr("fill-opacity",0),d3.select(this).select("animate").remove()}),a},castshadow:function(a){var b=a.data()[0].shadow,e=angular.isUndefined(b)?[]:[b],f=a.data()[0].scale_factor_shadow?a.data()[0].scale_factor_shadow:1;return 0!=e.length?(a.selectAll(".base").each(function(){var b=(d3.select(this).node().getBBox(),d3.select(d3.select(this).node().parentNode).select(".bulb").node().getBBox()),g=a.selectAll(".rg").data(e);g.enter().append("radialGradient").attr("id",a.attr("id")+"_shadow").attr("class","rg"),g.attr("cx",function(a){return a.center.x}).attr("cy",function(a){return a.center.y}).attr("r",function(a){return a.radius}).attr("fx",function(a){return a.focal.x}).attr("fy",function(a){return a.focal.y}).attr("spreadMethod","pad").attr("gradientTransform",function(a){return"rotate("+a.transform.rotate+","+a.center.x+","+a.center.y+") translate("+a.transform.translate.x+","+a.transform.translate.y+") scale("+a.transform.scale.x+","+a.transform.scale.y+")"}),g.selectAll("stop").data([]).exit().remove();var h=g.selectAll("stop").data(e[0].stops).enter().append("stop").attr("offset",function(a){return a.offset}).attr("stop-color",function(a){return a.color}).attr("stop-opacity",function(a){return a.opacity}),i=a.select(".bulb").attr("fill"),j=/\(.*\#([^)]+)\)/g,k=j.exec(i),l=d3.select("#"+k[1]).data()[0];if(l){var m=l.config.dur,n=l.config.begin,o=l.config.pattern_code;h.append("animate").attr("attributeName","stop-opacity").attr("values",function(a){for(var b,c="",d=0;d<o.length;d++)b=String(1==o[d]?a.opacity:0),c=c+b+";";return c+b}).attr("keyTimes",function(){for(var a="",b=0==o.length?1:1/o.length,c=0;c<o.length;c++)a=a+c*b+";";return a.length>0?a+"1":"0;1"}).attr("dur",m).attr("begin",c.incStep(n,.1)).attr("repeatCount","indefinite")}render_shadow=a.select("rect.shadow"),render_shadow.empty()&&(render_shadow=a.append("rect").attr("class","shadow")),render_shadow.attr("x",b.x-5*Math.max(b.width,b.height)*f).attr("y",b.y-5*Math.max(b.width,b.height)*f).attr("width",10*Math.max(b.width,b.height)*f).attr("height",10*Math.max(b.width,b.height)*f).attr("fill","url("+d.location+"#"+a.attr("id")+"_shadow)")}),a):void 0},uncastshadow:function(a){return a.selectAll(".shadow").remove(),a}},h=Object.create(g,{light_type:{writable:!1,value:"basicXmasLight"},light_subtype:{value:"C1"},scaleFactor:{writable:!0,configurable:!0,value:.2},desc:{configurable:!0,get:function(){return console.log("return "+desc),desc},set:function(a){console.log("haha, desc set to"+a),desc=a}}}),i=Object.create(g,{light_type:{writable:!1,value:"shiningXmasLight"},light_subtype:{value:"C1"},scaleFactor:{writable:!0,configurable:!0,value:.2},desc:{configurable:!0,get:function(){return console.log("return "+desc),desc},set:function(a){console.log("haha, desc set to"+a),desc=a}}}),j=Object.create(g,{light_type:{value:"basicGroundLight"},light_subtype:{value:"C9"},scaleFactor:{writable:!0,configurable:!0,value:1}}),k=Object.create(g,{light_type:{value:"measurementTapeEnd"},light_subtype:{value:""},light_unbreakable:{writable:!1,value:!0},light_unlightable:{writable:!1,value:!0},light_unflashable:{writable:!1,value:!0},color:{value:"white"},offset:{value:{x:5,y:-10}},scaleFactor:{writable:!1,configurable:!0,value:.5}}),l=Object.create(f,{light_type:{value:"fancyWreathImage"},light_subtype:{value:""},light_unbreakable:{writable:!1,value:!0},light_unlightable:{writable:!1,value:!0},light_unflashable:{writable:!1,value:!0},scaleFactor:{writable:!0,
configurable:!0,value:.5},url:{value:"/img/wreath.png"},size:{value:{width:120,height:120}},size_scale_func:{value:function(a,b){return a/(b*this.size.width)}},size_scale_reverse_func:{value:function(a,b){return a*b*this.size.width}}}),m=Object.create(f,{light_type:{value:"fancyGarlandImage"},light_subtype:{value:""},light_unbreakable:{writable:!1,value:!0},light_unlightable:{writable:!1,value:!0},light_unflashable:{writable:!1,value:!0},scaleFactor:{writable:!0,configurable:!0,value:1},url:{value:"/img/garland.png"},size:{value:{width:40,height:40}}});return{lights:[h,i,j,k,l,m],getLight:function(a){for(var b=0;b<this.lights.length;b++)if(this.lights[b].light_type.toLowerCase()==a.toLowerCase())return this.lights[b]}}}]),angular.module("lightgalaApp").factory("lightAnimService",["$timeout","utilService",function(a,b){var c={timers:[],init_config:function(){return this.animConfig||(this.animConfig={colorname:"white",stopcolor1:"hsl(0%,0%,0%)",stopcolor2:"hsl(0%,0%,0%)",pattern_code:"010",dur:"1.9s",begin:"0s",calcmode:""}),this},config:function(a){var b=this;for(key in a)b.animConfig.hasOwnProperty(key)&&(b.animConfig[key]=a[key]);return this},updateAnimElementFunc:function(){var a=this;return function(b){var d=b.data()[0];b.select("animate").attr("values",c.init_config().config(d.config).getColorPattern()).attr("dur",a.getDur()).attr("begin",a.getBegin())}},getColorPattern:function(){var a="",c=this.animConfig.pattern_code;if("rgb"==this.animConfig.colorname)return b.interpolateHSL(this.animConfig.stopcolor1,this.animConfig.stopcolor2,10);for(var d=0;d<c.length;d++)a+="0"==c[d]?this.animConfig.stopcolor1:this.animConfig.stopcolor2,a+=";";return a},getDur:function(){return this.animConfig.dur},getBegin:function(){return this.animConfig.begin},formAnimId:function(a,b,c,d,e){return a+"-"+b+"-"+c+"-"+d+"-"+e},setupOneAnimation:function(a,b,c,d,e,f){return{anim_id:this.formAnimId(a,b,c,d,e),decor_line_id:a,segment:b,set:c,color:d,start_second:e,active:f,config:_.clone(this.animConfig)}},setupAnimations:function(a,b,c,d,e,f,g){var h=this.formAnimId(b,c,d,e,f),i=_.find(a,function(a){return a.anim_id==h});return i?i.config=_.clone(this.animConfig):a.push(this.setupOneAnimation(b,c,d,e,f,g)),this},initialize:function(a,c,d,e,f,g,h){void 0==g&&(g=0);var i=this.formAnimId(c,d,e,f,g),j=_.find(a,function(a){return a.anim_id==i});if(!j){for(var k=0;k<h.length;k++){var l=h[k];(l.colorname==f||"random"==f)&&l.id.indexOf("flash")>0&&(this.config(l),this.setupAnimations(a,c,d,e,l.colorname,g,!0))}a.sort(b.dynamicSortMultiple("decor_line_id","start_second","set","segment","color"))}return this},install_lightoff:function(a){var b=a.attr("decor_line_id"),c=a.attr("segment"),d=a.attr("set");a.data()[0];a.append("radialGradient").attr("class","dynamic").attr("id",function(a){return"light-"+a.color+"-"+b+"-"+c+"-"+d}).attr("colorname",function(a){return a.color}).attr("r",3.81).attr("spreadMethod","pad").each(function(a,b){d3.select(this).append("stop").attr("offset",0).attr("stop-color",a.config.stopcolor1);d3.select(this).append("stop").attr("offset",1).attr("stop-color",a.config.stopcolor1)})},install_lighton:function(a){var b=a.attr("decor_line_id"),c=a.attr("segment"),d=a.attr("set");a.data()[0];a.append("radialGradient").attr("class","dynamic").attr("id",function(a){return"lighton-"+a.color+"-"+b+"-"+c+"-"+d}).attr("colorname",function(a){return a.color}).attr("r",3.81).attr("spreadMethod","pad").each(function(a,b){d3.select(this).append("stop").attr("offset",0).attr("stop-color",a.config.stopcolor2);d3.select(this).append("stop").attr("offset",1).attr("stop-color",a.config.stopcolor2)})},install_lightflash:function(a){var b=a.attr("decor_line_id"),d=a.attr("segment"),e=a.attr("set");a.data()[0];a.append("radialGradient").attr("class","dynamic").attr("id",function(a){return"lightflash-"+a.color+"-"+b+"-"+d+"-"+e}).attr("colorname",function(a){return a.color}).attr("r",3.81).attr("spreadMethod","pad").each(function(a,b){var d=d3.select(this).append("stop").attr("offset",0).attr("stop-color",a.config.stopcolor1);d.append("animate").attr("attributeName","stop-color").attr("values",c.init_config().config(a.config).getColorPattern()).attr("dur",a.config.dur).attr("begin",a.config.begin).attr("calcMode",a.config.calcmode).attr("repeatCount","indefinite"),d3.select(this).append("stop").attr("offset",1).attr("stop-color",a.config.stopcolor2)})},update_lightoff:function(a){var b=a.attr("decor_line_id"),c=a.attr("segment"),d=a.attr("set"),e=a.data()[0],f="light-"+e.color+"-"+b+"-"+c+"-"+d;a.select("#"+f).attr("colorname",function(a){return a.color}).attr("r",3.81).attr("spreadMethod","pad").each(function(a,b){d3.select(this).select("stop").attr("offset",0).attr("stop-color",a.config.stopcolor1);d3.select(this).select("stop").attr("offset",1).attr("stop-color",a.config.stopcolor1)})},update_lighton:function(a){var b=a.attr("decor_line_id"),c=a.attr("segment"),d=a.attr("set"),e=a.data()[0],f="lighton-"+e.color+"-"+b+"-"+c+"-"+d;a.select("#"+f).attr("colorname",function(a){return a.color}).attr("r",3.81).attr("spreadMethod","pad").each(function(a,b){d3.select(this).select("stop").attr("offset",0).attr("stop-color",a.config.stopcolor2);d3.select(this).select("stop").attr("offset",1).attr("stop-color",a.config.stopcolor2)})},update_lightflash:function(a){var b=a.attr("decor_line_id"),d=a.attr("segment"),e=a.attr("set"),f=a.data()[0],g="lightflash-"+f.color+"-"+b+"-"+d+"-"+e;a.select("#"+g).attr("colorname",function(a){return a.color}).attr("r",3.81).attr("spreadMethod","pad").each(function(a,b){var d=d3.select(this).select("stop").attr("offset",0).attr("stop-color",a.config.stopcolor1);d.select("animate").attr("attributeName","stop-color").attr("values",c.init_config().config(a.config).getColorPattern()).attr("dur",a.config.dur).attr("begin",a.config.begin).attr("calcMode",a.config.calcmode).attr("repeatCount","indefinite"),d3.select(this).select("stop").attr("offset",1).attr("stop-color",a.config.stopcolor2)})},start:function(b,c,d,e){var f=this,g=_.max(b,function(a){return a.start_second}).start_second+30;f.stop(function(){});for(var h=0;h<b.length;h++)f.timers.push(a(function(){var a=h;return function(){c(b[a].start_second)}}(),1e3*b[h].start_second));return f.timers.push(a(function(){console.log("restart cycle "+(e-1)),f.stop(d),e-1>0&&f.start(b,c,d,e-1)},1e3*g)),this},stop:function(b){if(this.timers.length>0){for(var c=0;c<this.timers.length;c++)a.cancel(this.timers[c]);this.timers=[],b()}}},d=Object.create(c,{anim_type:{value:"onandoff"}});return{anims:[d],getAnim:function(a){if(a)for(var b=0;b<this.anims.length;b++)if(this.anims[b].anim_type.toLowerCase()==a.toLowerCase())return this.anims[b].init_config();return d.init_config()}}}]),angular.module("lightgalaApp").factory("lightSvgsService",function(){return{svg_libs:[],loadAll:function(a){var b=this,c=[{light_type:"basicXmasLight",url:"/js/services/svgs/basicxmaslight.svg"},{light_type:"shiningXmasLight",url:"/js/services/svgs/shiningxmaslight.svg"},{light_type:"basicGroundLight",url:"/js/services/svgs/basicgroundlight.svg"},{light_type:"measurementTapeEnd",url:"/js/services/svgs/measurementtapeend.svg"}];for(i in c){var d=c[i].url;!function(){var e=i;a.xml(d,"image/svg+xml",function(d){var f=d.documentElement,g=a.select(f).select(".outline").attr("d"),h=a.select(f).select(".outline").attr("style"),i=a.select(f).select(".outline").attr("fill"),j=a.select(f).select(".outline").attr("fill-opacity"),k={x:a.select(f).select(".base").attr("x"),y:a.select(f).select(".base").attr("y"),width:a.select(f).select(".base").attr("width"),height:a.select(f).select(".base").attr("height")},l=a.select(f).select(".base").attr("style"),m=a.select(f).select(".base").attr("fill"),n=a.select(f).select(".base").attr("fill-opacity"),o=a.select(f).select(".bulb").attr("d"),p=a.select(f).select(".bulb").attr("style");bulb_fill=a.select(f).select(".bulb").attr("fill"),bulb_fillopacity=a.select(f).select(".bulb").attr("fill-opacity"),ray_path=a.select(f).select(".ray").attr("d"),ray_style=a.select(f).select(".ray").attr("style"),ray_fill=a.select(f).select(".ray").attr("fill"),ray_fillopacity=a.select(f).select(".ray").attr("fill-opacity"),b.svg_libs.push({light_type:c[e].light_type,outline_path:g,outline_style:h,outline_fill:i,outline_fillopacity:j,base:k,base_style:l,base_fill:m,base_fillopacity:n,bulb_path:o,bulb_style:p,bulb_fill:bulb_fill,bulb_fillopacity:bulb_fillopacity,ray_path:ray_path,ray_style:ray_style,ray_fill:ray_fill,ray_fillopacity:ray_fillopacity})})}()}},getSvgByType:function(a){for(var b=0;b<this.svg_libs.length;b++)if(this.svg_libs[b].light_type==a)return this.svg_libs[b]}}}),angular.module("lightgalaApp").factory("subscriptionService",["$http",function(a){return{subscribe:function(b,c){return a.post("/db2/api/subscribe",{decor_id:b._id})},unsubscribe:function(b,c){return a.post("/db2/api/unsubscribe",{decor_id:b._id})},thumbup:function(b){return a.post("/db2/api/thumbup",{decor_id:b._id})},thumbdown:function(b){return a.post("/db2/api/thumbdown",{decor_id:b._id})}}}]),angular.module("lightgalaApp").factory("toolService",["$location","decorService","decorDataService","lightService","lightAnimService","utilService","$modal","$aside","$alert","$popover","$injector",function(a,b,c,d,e,f,g,h,i,j,k){var l={current_config:{color:"white",rotate_degree:0,rotate:function(){var a=Array.prototype.slice.call(arguments,0);if(1==a.length){var b=a[0];return"random"==b?Math.floor(180*Math.random()-360):b}return"random"==this.rotate_degree?Math.floor(180*Math.random()-360):this.rotate_degree},gap:25,scale_factor:.3,set_scale_factor:1,decor_method:"lineMulti",night:!1,anim_type:"onandoff",anim_start_second:0,scale_factor_shadow:1,rgConfigured:{width:276,height:276,center:{x:.5,y:.5},focal:{x:.5,y:.5},radius:.1,transform:{rotate:0,translate:{x:0,y:0},scale:{x:1,y:1}},opacity:.6,stops:[{offset:"0",color:"rgb(255,255,255)",opacity:1},{offset:"1",color:"rgb(0,0,0)",opacity:0}]},install_supported_defs:function(a){return this.defs=a,this},reset:function(){return this.color="white",this.rotate_degree=0,this.gap=25,this.scale_factor=.3,this.decor_method="lineMulti",this.night=!1,this.anim_start_second=0,this}},beforeinvoke:function(a){return this},invoke:function(){return this},afterinvoke:function(a){if(a&&a.current.decor.hasOwnProperty("line_id")){a.element_config.defs=a.data.defs;var c,d,g=f.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id),h=f.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines[g].elements,"id",a.current.decor.line_element_id),i=b.getDecor(a.data.decor.decor_lines[g].decor_line_type).config(a.element_config);if(h)i.updateElementWithConfig(a.data.decor.decor_lines[g].elements[h],i.elementConfig),c=a.data.decor.decor_lines[g].elements[h].segment,d=a.data.decor.decor_lines[g].elements[h].set,e.getAnim().initialize(a.data.animations,a.current.decor.line_id,c,d,i.elementConfig.color,i.elementConfig.anim_start_second,a.data.defs[0].attributes);else{var j=_.max(_.pluck(a.data.decor.decor_lines[g].elements,function(a){return a.set})),k=_.filter(a.data.decor.decor_lines[g].elements,function(a){return a.set==j});_.forEach(k,function(a){i.updateElementWithConfig(a,i.elementConfig)});var l=_.unique(_.map(k,function(a){return{segment:a.segment,set:a.set,color:a.color}}));_.forEach(l,function(b){e.getAnim().initialize(a.data.animations,a.current.decor.line_id,b.segment,b.set,i.elementConfig.color,i.elementConfig.anim_start_second,a.data.defs[0].attributes)})}a.decor_line_element_update_func(a.current.decor.line_id),a.initShadowStopColors()}return this}},m=Object.create(l,{instructions:{value:"use basic xmas light"},toolName:{value:"basicxmaslighttypetool"},invokeWillSet:{value:{key:"light_type",value:"basicXmasLight"}},invoke:{value:function(){return this.current_config.light_type="basicXmasLight",this}}}),n=Object.create(l,{instructions:{value:"use basic ground light"},toolName:{value:"basicgroundlighttypetool"},invokeWillSet:{value:{key:"light_type",value:"basicGroundLight"}},invoke:{value:function(){return this.current_config.light_type="basicGroundLight",this}}}),o=Object.create(l,{instructions:{value:"use shining xmas light"},toolName:{value:"shiningxmaslighttypetool"},invokeWillSet:{value:{key:"light_type",value:"shiningXmasLight"}},invoke:{value:function(){return this.current_config.light_type="shiningXmasLight",this}}}),p=Object.create(l,{instructions:{value:"decorate one item at end of the line"},toolName:{value:"lineonetool"},invokeWillSet:{value:{key:"decor_method",value:"lineOne"}},invoke:{value:function(){return this.current_config.decor_method="lineOne",this}}}),q=Object.create(l,{instructions:{value:"decorate multiple items on the line"},toolName:{value:"linemultitool"},invokeWillSet:{value:{key:"decor_method",value:"lineMulti"}},invoke:{value:function(){return this.current_config.decor_method="lineMulti",this}}}),r=Object.create(l,{instructions:{value:"decorate multiple items inside the polygon"},toolName:{value:"polymultitool"},invokeWillSet:{value:{key:"decor_method",value:"polyMulti"}},invoke:{value:function(){return this.current_config.decor_method="polyMulti",this}}}),s=Object.create(l,{instructions:{value:"use yellow color for the decorated item"},toolName:{value:"yellowcolortool"},invokeWillSet:{value:{key:"color",value:"yellow"}},invoke:{value:function(){return this.current_config.color="yellow",this}}}),t=Object.create(l,{instructions:{value:"use orange color for the decorated item"},toolName:{value:"orangecolortool"},invokeWillSet:{value:{key:"color",value:"orange"}},invoke:{value:function(){return this.current_config.color="orange",this}}}),u=Object.create(l,{instructions:{value:"use green color for the decorated item"},toolName:{value:"greencolortool"},invokeWillSet:{value:{key:"color",value:"green"}},invoke:{value:function(){return this.current_config.color="green",this}}}),v=Object.create(l,{instructions:{value:"use purple color for the decorated item"},toolName:{value:"purplecolortool"},invokeWillSet:{value:{key:"color",value:"purple"}},invoke:{value:function(){return this.current_config.color="purple",this}}}),w=Object.create(l,{instructions:{value:"use blue color for the decorated item"},toolName:{value:"bluecolortool"},invokeWillSet:{value:{key:"color",value:"blue"}},invoke:{value:function(){return this.current_config.color="blue",this}}}),x=Object.create(l,{instructions:{value:"use red color for the decorated item"},toolName:{value:"redcolortool"},invokeWillSet:{value:{key:"color",value:"red"}},invoke:{value:function(){return this.current_config.color="red",this}}}),y=Object.create(l,{instructions:{value:"use white color for the decorated item"},toolName:{value:"whitecolortool"},invokeWillSet:{value:{key:"color",value:"white"}},invoke:{value:function(){return this.current_config.color="white",this}}}),z=Object.create(l,{instructions:{value:"use random color for the decorated item"},toolName:{value:"randomcolortool"},invokeWillSet:{value:{key:"color",value:"random"}},invoke:{value:function(){return this.current_config.color="random",this}}}),A=Object.create(l,{instructions:{value:"use LED configurable color for the decorated item"},toolName:{value:"rgbcolortool"},invokeWillSet:{value:{key:"color",value:"rgb"}},invoke:{value:function(){return this.current_config.color="rgb",this}}}),B=(Object.create(l,{instructions:{value:"choose a color for the decorated item"},toolName:{value:"colorchoosertool"},invokeWillSet:{value:{key:"",value:""}},invoke:{value:function(){return this}}}),Object.create(l,{instructions:{value:"enlarge the decorated item"},toolName:{value:"sizeuptool"},invokeWillSet:{value:{key:"scale_factor",value:1.2*l.current_config.scale_factor}},invoke:{value:function(){return this.current_config.scale_factor=1.2*this.current_config.scale_factor,this}}})),C=Object.create(l,{instructions:{value:"shrink the decorated item"},toolName:{value:"sizedowntool"},invokeWillSet:{value:{key:"scale_factor",value:.8*l.current_config.scale_factor}},invoke:{value:function(){return this.current_config.scale_factor=.8*this.current_config.scale_factor,this}}}),D=Object.create(l,{instructions:{value:"enlarge the set of decorated items"},toolName:{value:"setsizeuptool"},invokeWillSet:{value:{key:"set_scale_factor",value:1.2*l.current_config.set_scale_factor}},invoke:{value:function(){return this.current_config.set_scale_factor=1.2*this.current_config.set_scale_factor,this}}}),E=Object.create(l,{instructions:{value:"shrink the set of decorated item"},toolName:{value:"setsizedowntool"},invokeWillSet:{value:{key:"set_scale_factor",value:.8*l.current_config.set_scale_factor}},invoke:{value:function(){return this.current_config.set_scale_factor=.8*this.current_config.set_scale_factor,this}}}),F=Object.create(l,{instructions:{value:"make decorated items farther from each other"},toolName:{value:"gapuptool"},invokeWillSet:{value:{key:"gap",value:1.2*l.current_config.gap}},invoke:{value:function(){return this.current_config.gap=1.2*this.current_config.gap,this}},afterinvoke:{value:function(a){if(a&&a.current.decor.hasOwnProperty("line_id")){var b=f.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id),c=f.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines[b].elements,"id",a.current.decor.line_element_id),d=a.xScale(this.current_config.gap);c?a.showTraceCircleFromPointWithRadius({x:a.xScale(a.data.decor.decor_lines[b].elements[c].x),y:a.yScale(a.data.decor.decor_lines[b].elements[c].y)},d):_.forEach(a.data.decor.decor_lines[b].elements,function(b){a.showTraceCircleFromPointWithRadius({x:a.xScale(b.x),y:a.yScale(b.y)},d)})}return this.__proto__.afterinvoke(a),this}}}),G=Object.create(l,{instructions:{value:"make decorated items closer to each other"},toolName:{value:"gapdowntool"},invokeWillSet:{value:{key:"gap",value:.8*l.current_config.gap}},invoke:{value:function(){return this.current_config.gap=.8*this.current_config.gap,this}},afterinvoke:{value:function(a){return F.afterinvoke(a)}}}),H=(Object.create(l,{instructions:{value:"rotate the decorated item"},toolName:{value:"rotatetool"},invokeWillSet:{value:{key:"",value:""}},invoke:{value:function(){return this}}}),Object.create(l,{instructions:{value:"rotate the decorated item counter clock wise by 30 degree"},toolName:{value:"rotatelefttool"},invokeWillSet:{value:{key:"rotate_degree",value:parseInt(l.current_config.rotate_degree)-30}},invoke:{value:function(){return"random"==this.current_config.rotate_degree?this.current_config.rotate_degree=0:this.current_config.rotate_degree=parseInt(this.current_config.rotate_degree)-30,this}}})),I=Object.create(l,{instructions:{value:"rotate the decorated item clock wise by 30 degree"},toolName:{value:"rotaterighttool"},invokeWillSet:{value:{key:"rotate_degree",value:parseInt(l.current_config.rotate_degree)+30}},invoke:{value:function(){return"random"==this.current_config.rotate_degree?this.current_config.rotate_degree=0:this.current_config.rotate_degree=parseInt(this.current_config.rotate_degree)+30,this}}}),J=Object.create(l,{instructions:{value:"rotate the decorated item randomly"},toolName:{value:"rotaterandomtool"},invokeWillSet:{value:{key:"rotate_degree",value:"random"}},invoke:{value:function(){return this.current_config.rotate_degree="random",this}}}),K=Object.create(l,{instructions:{value:"increase shadow size of decorated item"},toolName:{value:"shadowsizeuptool"},invokeWillSet:{value:{key:"scale_factor_shadow",value:1.2*l.current_config.scale_factor_shadow}},invoke:{value:function(){return this.current_config.scale_factor_shadow=1.2*this.current_config.scale_factor_shadow,this}},afterinvoke:{value:function(a){if(this.__proto__.afterinvoke(a),a.current.decor.line_element_id){var b=d3.select("g[decor_line_id='"+a.current.decor.line_id+"'][decor_line_element_id='"+a.current.decor.line_element_id+"']"),c=d.getLight(b.data()[0].light_type);b.call(c.turnon).call(c.flash).call(c.glow).call(c.castshadow).call(c.emitray)}else if(a.current.decor.line_id){var e=d3.selectAll("g[decor_line_id='"+a.current.decor.line_id+"'].decor_line_element");e.each(function(){var a=d3.select(this),b=d.getLight(a.data()[0].light_type);a.call(b.turnon).call(b.flash).call(b.glow).call(b.castshadow).call(b.emitray)})}return this}}}),L=Object.create(l,{instructions:{value:"decrease shadow size of decorated item"},toolName:{value:"shadowsizedowntool"},invokeWillSet:{value:{key:"scale_factor_shadow",value:.8*l.current_config.scale_factor_shadow}},invoke:{value:function(){return this.current_config.scale_factor_shadow=.8*this.current_config.scale_factor_shadow,this}},afterinvoke:{value:function(a){if(this.__proto__.afterinvoke(a),a.current.decor.line_element_id){var b=d3.select("g[decor_line_id='"+a.current.decor.line_id+"'][decor_line_element_id='"+a.current.decor.line_element_id+"']"),c=d.getLight(b.data()[0].light_type);b.call(c.turnon).call(c.flash).call(c.glow).call(c.castshadow).call(c.emitray)}else if(a.current.decor.line_id){var e=d3.selectAll("g[decor_line_id='"+a.current.decor.line_id+"'].decor_line_element");e.each(function(){var a=d3.select(this),b=d.getLight(a.data()[0].light_type);a.call(b.turnon).call(b.flash).call(b.glow).call(b.castshadow).call(b.emitray)})}return this}}}),M=Object.create(l,{instructions:{value:"let the night begin"},toolName:{value:"nighttool"},invokeWillSet:{value:{key:"night",value:l.current_config.night?!1:!0}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){a.current.animation.night=a.current.animation.night?!1:!0}}}),N=Object.create(l,{instructions:{value:"let the light show start"},toolName:{value:"animatestarttool"},invokeWillSet:{value:{key:"animate",value:l.current_config.animate?!1:!0}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){a.current.animation.start=a.current.animation.start?!1:!0,a.$$phase||a.$apply()}}}),O=Object.create(l,{instructions:{value:"configure start second of the animation"},toolName:{value:"animatestartplusfivesecondtool"},invokeWillSet:{value:{key:"animate",value:l.current_config.animate?!1:!0}},invoke:{value:function(){return this.current_config.anim_start_second+=5,this}},afterinvoke:{value:function(a){a.$$phase||a.$apply(),this.__proto__.afterinvoke(a)}}}),P=Object.create(l,{instructions:{value:"configure start second of the animation"},toolName:{value:"animatestartminusfivesecondtool"},invokeWillSet:{value:{key:"animate",value:l.current_config.animate?!1:!0}},invoke:{value:function(){return this.current_config.anim_start_second-=5,this}},afterinvoke:{value:function(a){a.$$phase||a.$apply(),this.__proto__.afterinvoke(a)}}}),Q=(Object.create(l,{instructions:{value:"configure animate pattern to on,off,off,on,off,on,off"},toolName:{value:"animatepattern1tool"},invokeWillSet:{value:{key:"animate_pattern",value:"1001010"}},invoke:{value:function(){return this.current_config.anim_pattern="1001010",this}},afterinvoke:{value:function(a){for(var b=0;b<a.data.animations.length;b++){var c=a.data.animations[b];c.decor_line_id==a.current.decor.line_id&&c.start_second==a.element_config.anim_start_second&&c.color==a.element_config.color&&(c.config.pattern_code=this.current_config.anim_pattern)}a.$$phase||a.$apply(),this.__proto__.afterinvoke(a)}}}),Object.create(l,{instructions:{value:"increase animation duration"},toolName:{value:"animateduruptool"},invokeWillSet:{value:{key:"animate_dur",value:1.25*l.current_config.animate_dur}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){for(var b=0;b<a.data.animations.length;b++){var c=a.data.animations[b];c.decor_line_id==a.current.decor.line_id&&c.start_second==a.element_config.anim_start_second&&c.color==a.element_config.color&&(c.config.dur=f.incStep(c.config.dur))}a.$$phase||a.$apply(),this.__proto__.afterinvoke(a)}}}),Object.create(l,{instructions:{value:"decrease animation duration"},toolName:{value:"animatedurdowntool"},invokeWillSet:{value:{key:"animate_dur",value:l.current_config.animate_dur/1.25}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){for(var b=0;b<a.data.animations.length;b++){var c=a.data.animations[b];c.decor_line_id==a.current.decor.line_id&&c.start_second==a.element_config.anim_start_second&&c.color==a.element_config.color&&(c.config.dur=f.decStep(c.config.dur))}a.$$phase||a.$apply(),this.__proto__.afterinvoke(a)}}}),Object.create(l,{instructions:{value:"delay more time before animation"},toolName:{value:"animatebeginlatertool"},invokeWillSet:{value:{key:"animate_begin",value:1.25*l.current_config.animate_begin}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){for(var b=0;b<a.data.animations.length;b++){var c=a.data.animations[b];c.decor_line_id==a.current.decor.line_id&&c.start_second==a.element_config.anim_start_second&&c.color==a.element_config.color&&(c.config.begin=f.incStep(c.config.begin,.5))}a.$$phase||a.$apply(),this.__proto__.afterinvoke(a)}}}),Object.create(l,{instructions:{value:"delay less time before animation"},toolName:{value:"animatebeginsoonertool"},invokeWillSet:{value:{key:"animate_begin",value:l.current_config.animate_begin/1.25}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){for(var b=0;b<a.data.animations.length;b++){var c=a.data.animations[b];c.decor_line_id==a.current.decor.line_id&&c.start_second==a.element_config.anim_start_second&&c.color==a.element_config.color&&(c.config.begin=f.decStep(c.config.begin,.5))}a.$$phase||a.$apply(),this.__proto__.afterinvoke(a)}}}),Object.create(l,{instructions:{value:"specify scale of the photo by providing length to a measured distance"},toolName:{value:"measuretool"},invokeWillSet:{value:{key:"light_type",value:"measurementTapeEnd"}},invoke:{value:function(){return this.current_config.light_type="measurementTapeEnd",this.current_config.decor_method="lineOne",this}},afterinvoke:{value:function(a){a.current.widget.line_type="measurementScaling";var b=f.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_type",a.current.widget.line_type);return angular.isUndefined(b)||(a.toggleDecorLine(a.data.decor.decor_lines[b].decor_line_id),a.init_current()),this}}})),R=Object.create(l,{instructions:{value:"a fancy wreath with red bow, pine cone and mixed berry"},toolName:{value:"fancywreathimagetool"},invokeWillSet:{value:{key:"light_type",value:"fancyWreathImage"}},invoke:{value:function(){return this.current_config.light_type="fancyWreathImage",this.current_config.decor_method="lineOne",this}}}),S=Object.create(l,{instructions:{value:"a fancy garland"},toolName:{value:"fancygarlandimagetool"},invokeWillSet:{value:{key:"light_type",value:"fancyGarlandImage"}},invoke:{value:function(){return this.current_config.light_type="fancyGarlandImage",this.current_config.decor_method="lineMulti",this}}}),T=Object.create(l,{instructions:{value:"24 inches wreath with red bow"},toolName:{value:"24inchwreathimagetool"},invokeWillSet:{value:{key:"light_type",value:"fancyWreathImage"}},invoke:{value:function(){return this.current_config.light_type="fancyWreathImage",this.current_config.decor_method="lineOne",this}},afterinvoke:{value:function(a){if(a.data.decor.num_inches_per_x_unit){var b=d.getLight("fancyWreathImage");this.current_config.scale_factor=b.size_scale_func(24,a.data.decor.num_inches_per_x_unit)}return this}}}),U=Object.create(l,{instructions:{value:"30 inches wreath with red bow"},toolName:{value:"30inchwreathimagetool"},invokeWillSet:{value:{key:"light_type",value:"fancyWreathImage"}},invoke:{value:function(){return this.current_config.light_type="fancyWreathImage",this.current_config.decor_method="lineOne",this}},afterinvoke:{value:function(a){if(a.data.decor.num_inches_per_x_unit){var b=d.getLight("fancyWreathImage");this.current_config.scale_factor=b.size_scale_func(30,a.data.decor.num_inches_per_x_unit)}return this}}}),V=Object.create(l,{instructions:{value:"36 inches wreath with red bow"},toolName:{value:"36inchwreathimagetool"},invokeWillSet:{value:{key:"light_type",value:"fancyWreathImage"}},invoke:{value:function(){return this.current_config.light_type="fancyWreathImage",this.current_config.decor_method="lineOne",this}},afterinvoke:{value:function(a){if(a.data.decor.num_inches_per_x_unit){var b=d.getLight("fancyWreathImage");this.current_config.scale_factor=b.size_scale_func(36,a.data.decor.num_inches_per_x_unit)}return this}}}),W=Object.create(l,{instructions:{value:"48 inches wreath with red bow"},toolName:{value:"48inchwreathimagetool"},invokeWillSet:{value:{key:"light_type",value:"fancyWreathImage"}},invoke:{value:function(){return this.current_config.light_type="fancyWreathImage",this.current_config.decor_method="lineOne",this}},afterinvoke:{value:function(a){if(a.data.decor.num_inches_per_x_unit){var b=d.getLight("fancyWreathImage");this.current_config.scale_factor=b.size_scale_func(48,a.data.decor.num_inches_per_x_unit)}return this}}}),X=Object.create(l,{instructions:{value:"60 inches wreath with red bow"},toolName:{value:"60inchwreathimagetool"},invokeWillSet:{value:{key:"light_type",value:"fancyWreathImage"}},invoke:{value:function(){return this.current_config.light_type="fancyWreathImage",this.current_config.decor_method="lineOne",this}},afterinvoke:{value:function(a){if(a.data.decor.num_inches_per_x_unit){var b=d.getLight("fancyWreathImage");this.current_config.scale_factor=b.size_scale_func(60,a.data.decor.num_inches_per_x_unit)}return this}}}),Y=Object.create(l,{instructions:{value:"save the decoration to the cloud"},toolName:{value:"savetool"},invokeWillSet:{value:{key:"",value:""}},beforeinvoke:{value:function(a){if(0==a.data.decor.decor_lines.length&&!a.data.decor.backgroundurl)return i({title:"can not save empty decor!",content:"There is nothing to save",placement:"top-right",type:"danger",duration:3}),!1;var b=h({scope:a,template:"partials/savedecor.html",placement:"left",keyboard:!0,show:!1,animation:"am-slide-left",title:"Save Decoration"});return a.saveDialog=b,b.$promise.then(function(){b.show()}),this}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){}}}),Z=Object.create(l,{instructions:{value:"delete the decoration from the cloud"},toolName:{value:"deletetool"},invokeWillSet:{value:{key:"",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){g({template:"partials/deletedecor.html",show:!0,backdrop:"static",scope:a})}}}),aa=Object.create(l,{instructions:{value:"exit the decor screen and clean decor data"},toolName:{value:"exittool"},invokeWillSet:{value:{key:"",value:""}},beforeinvoke:{value:function(a){return this}},invoke:{value:function(){return this}},afterinvoke:{value:function(b){c.resetData(),b.keepDataInCache=!1,a.path("/")}}}),ba=(Object.create(l,{instructions:{value:"play music"},toolName:{value:"musictoolold"},invokeWillSet:{value:{key:"music",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){function b(){a.current.music||(a.current.music={}),a.current.music.playing?d():c()}function c(){if("undefined"!=typeof a.current.music.track){var b=a.current.music.track.getDuration();a.current.music.playing=!0,f(b),a.current.music.track.play(a.song)}else a.current.music.playing=!1,createjs.Sound.removeAllEventListeners("fileload"),createjs.Sound.registerPlugins([createjs.WebAudioPlugin,createjs.FlashAudioPlugin]),createjs.Sound.alternateExtensions=["mp3"],createjs.Sound.registerSound(a.song,a.song,1,!0,"/img/"),createjs.Sound.addEventListener("fileload",g)}function d(){a.current.music.track&&(a.current.music.playing=!1,a.current.music.track.pause()),clearInterval(a.current.music.progress_timer)}function e(){a.current.music.playing=!1,a.$$phase||a.$apply()}function f(b){a.current.music.progress_timer=setInterval(function(){var c=a.current.music.track.getPosition(),d=Math.round(100*c/b)/100;$(".decor-ctrls .progress-bar").css("width",function(a){return 100>100*d?100*d+"%":void 0})},100)}function g(){a.current.music.track=createjs.Sound.createInstance(a.song),a.current.music.progress_timer=0;
var b=a.current.music.track.getDuration();f(b),a.current.music.track.play(),a.current.music.playing=!0,a.$$phase||a.$apply(),a.current.music.track.on("complete",e),$(".progress").bind("click",function(c){var d=$(c.target),e=(d.find(".progress-bar"),d.offset()),f=c.clientX-e.left,g=100*f/d.width();a.current.music.playing&&(a.current.music.track.setPosition(b*g/100),d3.select(".decor-ctrls .progress-bar").style("width",g+"%"))})}b()}}}),Object.create(l,{instructions:{value:"adjust music volume"},toolName:{value:"volumeonofftoolold"},invokeWillSet:{value:{key:"",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){if(a.current.music.track){a.current.music.track.volume=0==a.current.music.track.volume?.5:0;var b=_.find(a.data.tools,function(a){return"volumeonofftool"==a.name});0==a.current.music.track.volume?b.icon_toggle=!0:b.icon_toggle=!1}}}}),Object.create(l,{instructions:{value:"play music"},toolName:{value:"musictool"},invokeWillSet:{value:{key:"music",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){function b(){a.current.music||(a.current.music={}),a.current.music.playing?d():c()}function c(){"undefined"!=typeof a.current.music.track?(a.current.music.playing=!0,a.current.music.track.play({onfinish:e,whileplaying:function(){f(this.position,this.duration)}})):(a.current.music.playing=!1,soundManager.setup({flashVersion:9,onready:function(){a.data.decor.mediaurl||(a.data.decor.mediaurl="img/PaulGentry_ChristmasMorning.mp3");var b=soundManager.createSound({id:"backgroundmusic",url:a.data.decor.mediaurl});a.current.music.track=b,b.load({onload:function(){g=this.duration}}),a.current.music.progress_timer=0,a.current.music.track.play({onfinish:e,whileplaying:function(){f(this.position,this.duration)}}),a.current.music.playing=!0,a.$$phase||a.$apply(),$(".progress").bind("click",function(b){var c=$(b.target),d=(c.find(".progress-bar"),c.offset()),e=b.clientX-d.left,f=100*e/c.width();a.current.music.playing&&(soundManager.setPosition("backgroundmusic",g*f/100),d3.select(".decor-ctrls .progress-bar").style("width",f+"%"))})},ontimeout:function(){alert("Can not play sound!")}}))}function d(){a.current.music.track&&(a.current.music.playing=!1,a.current.music.track.pause())}function e(){a.current.music.playing=!1,a.current.animation.night=!1,a.current.animation.start=!1,$(".decor-ctrls .progress-bar").css("width",function(a){return"0%"}),a.$$phase||a.$apply()}function f(a,b){var c=Math.round(100*a/b)/100;$(".decor-ctrls .progress-bar").css("width",function(a){return 100>100*c?100*c+"%":void 0})}var g=0;b()}}})),ca=Object.create(l,{instructions:{value:"adjust music volume"},toolName:{value:"volumeonofftool"},invokeWillSet:{value:{key:"",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){if(a.current.music.track){a.current.music.track.toggleMute();var b=_.find(a.data.tools,function(a){return"volumeonofftool"==a.name});b.icon_toggle=a.current.music.track.muted}}}}),da=Object.create(l,{instructions:{value:"load or take a picture"},toolName:{value:"cameratool"},invokeWillSet:{value:{key:"backgroundurl",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){function b(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:alert("File Not Found!");break;case a.taget.error.NOT_READABLE_ERR:alert("File is not readable");break;case a.target.error.ABORT_ERR:break;default:alert("Error coocurred while reading file")}}function c(a){if(a.lengthComputable){var b=Math.round(a.loaded/a.total*100);100>b&&(f.attr("style","width:'"+b+"%'"),f.attr("textContent",b+"%"))}}function d(d){f.attr("style","width:'0%'"),f.attr("textContent","0%"),e=new FileReader,e.onerror=b,e.onprogress=c,e.onabort=function(a){alert("File read cancelled")},e.onloadstart=function(a){$("#background_img_file").attr("class","loading")},e.onloadend=function(b){b.preventDefault(),f.attr("style","width:'100%'"),f.attr("textContent","100%"),setTimeout(function(){$("#background_img_file").attr("class","")},2e3);var c=_.reduce(_.map(a.data.decor.decor_lines,function(a){return a.elements.length}),function(a,b){return a+b});return c>0?confirm("Do you want to start over?")?(a.clear_all_decors(),a.data.decor.backgroundurl=b.target.result,a.setDirty(!0),a.$$phase||a.$apply(),!1):($("#background_img_file").val(""),!1):(a.data.decor.backgroundurl=b.target.result,void(a.$$phase||a.$apply()))},e.readAsDataURL(d.target.files[0])}var e,f=$(".percent");$("#background_img_file").unbind("change").on("change",d),$("#background_img_file").click()}}}),ea=Object.create(l,{instructions:{value:"load a music"},toolName:{value:"loadmediatool"},invokeWillSet:{value:{key:"mediaurl",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){g({template:"partials/loaddecormusic.html",show:!0,backdrop:"static",scope:a})}}}),fa=Object.create(l,{instructions:{value:"load a picture or a music"},toolName:{value:"loadmediatool2"},invokeWillSet:{value:{key:"mediaurl",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){function b(a){switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:alert("File Not Found!");break;case a.taget.error.NOT_READABLE_ERR:alert("File is not readable");break;case a.target.error.ABORT_ERR:break;default:alert("Error coocurred while reading file")}}function c(a){if(a.lengthComputable){var b=Math.round(a.loaded/a.total*100);100>b&&(f.attr("style","width:'"+b+"%'"),f.attr("textContent",b+"%"))}}function d(d){f.attr("style","width:'0%'"),f.attr("textContent","0%"),e=new FileReader,e.onerror=b,e.onprogress=c,e.onabort=function(a){alert("File read cancelled")},e.onloadstart=function(a){$("#background_img_file").attr("class","loading")},e.onloadend=function(b){b.preventDefault(),f.attr("style","width:'100%'"),f.attr("textContent","100%"),setTimeout(function(){$("#background_img_file").attr("class","")},2e3);_.reduce(_.map(a.data.decor.decor_lines,function(a){return a.elements.length}),function(a,b){return a+b});a.data.decor.mediaurl=b.target.result,a.setDirty(!0),a.current.music.playing=!1,a.current.animation.start=!1,a.current.music.track&&(a.current.music.track.destruct(),a.current.music.track=void 0,a.current.music.playing=!1),a.$$phase||a.$apply()},e.readAsDataURL(d.target.files[0])}var e,f=$(".percent");$("#background_img_file").unbind("change").on("change",d),$("#background_img_file").click()}}}),ga=Object.create(l,{instructions:{value:"let it snow"},toolName:{value:"snowtool"},invokeWillSet:{value:{key:"",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){var b=function(b){$("div.decormain div.weather").remove(),$("div.decormain").append("<div class='weather' snow></div>"),b($("div.weather"))(a)};b.$inject=["$compile"],k.invoke(b,null)}}}),ha=Object.create(l,{instructions:{value:"wet day"},toolName:{value:"raintool"},invokeWillSet:{value:{key:"",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){var b=function(b){$("div.decormain div.weather").remove(),$("div.decormain").append("<div class='weather' rain></div>"),b($("div.weather"))(a)};b.$inject=["$compile"],k.invoke(b,null)}}}),ia=Object.create(l,{instructions:{value:"a clear bright day"},toolName:{value:"sunnytool"},invokeWillSet:{value:{key:"",value:""}},invoke:{value:function(){return this}},afterinvoke:{value:function(a){$("div.decormain div.weather").remove()}}});return{tools:[m,n,o,p,q,r,s,y,t,u,w,x,v,z,A,B,C,D,E,F,G,K,L,H,I,J,M,Q,da,ea,fa,ba,ca,ga,ha,ia,N,O,P,R,T,U,V,W,X,S,Y,Z,aa],getTool:function(a){for(var b=0;b<this.tools.length;b++)if(this.tools[b].toolName.toLowerCase()==a.toLowerCase())return this.tools[b];return l},getToolByConfigField:function(a,b){for(var c=0;c<this.tools.length;c++)if(this.tools[c].invokeWillSet.key==a&&this.tools[c].invokeWillSet.value==b)return this.tools[c];return l}}}]),angular.module("lightgalaApp").factory("utilService",function(){return{getArrayIndexWithPropertyEqualTo:function(a,b,c){for(var d=0;d<a.length;d++)if(angular.isObject(a[d])&&a[d].hasOwnProperty(b)&&a[d][b]==c)return d;return void 0},getArrayIndexWithPropertyEqualToIgnoreCase:function(a,b,c){for(var d=0;d<a.length;d++)if(angular.isObject(a[d])&&a[d].hasOwnProperty(b)&&(a[d][b]+"").toLowerCase()==(c+"").toLowerCase())return d;return void 0},uniqueId:function(a){return Date.now()+"_"+a},maxmin:function(a,b){for(var c,d=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,f=a.length-1;f>=0;f--)c=b(a[f]),d>c&&(d=c),c>e&&(e=c);return{max:e,min:d}},removeArrayElementSatisfy:function(a,b){for(var c=a.length-1;c>=0;c--)b(a[c])&&a.splice(c,1);return a},isNumber:function(a){return a==parseFloat(a)},isEven:function(a){return this.isNumber(a)&&a%2==0},isOdd:function(a){return this.isNumber(a)&&Math.abs(a)%2==1},dist:function(a,b){return Math.round(Math.sqrt(Math.pow(b[1]-a[1],2)+Math.pow(b[0]-a[0],2)))},addEvent:function(a,b,c){null!=a&&"undefined"!=typeof a&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c)},onceFunc:function(a){var b=0;return function(){0==b&&(b+=1,a())}},nceFunc:function(a,b){var c=0;return function(){b>c&&(c+=1,a())}},convertToRelative:function(a){function b(b){var c=[].slice.call(arguments,1),d="createSVGPathSeg"+b+"Rel",e=a[d].apply(a,c);k.replaceItem(e,n)}for(var c,d,e,f,g,h,i,j,k=a.pathSegList,l=0,m=0,n=0,o=k.numberOfItems;o>n;n++){var p=k.getItem(n),q=p.pathSegTypeAsLetter;if(/[MLHVCSQTAZz]/.test(q))switch("x1"in p&&(g=p.x1-l),"x2"in p&&(i=p.x2-l),"y1"in p&&(h=p.y1-m),"y2"in p&&(j=p.y2-m),"x"in p&&(c=-l+(l=p.x)),"y"in p&&(d=-m+(m=p.y)),q){case"M":b("Moveto",c,d);break;case"L":b("Lineto",c,d);break;case"H":b("LinetoHorizontal",c);break;case"V":b("LinetoVertical",d);break;case"C":b("CurvetoCubic",c,d,g,h,i,j);break;case"S":b("CurvetoCubicSmooth",c,d,i,j);break;case"Q":b("CurvetoQuadratic",c,d,g,h);break;case"T":b("CurvetoQuadraticSmooth",c,d);break;case"A":b("Arc",c,d,p.r1,p.r2,p.angle,p.largeArcFlag,p.sweepFlag);break;case"Z":case"z":l=e,m=f}else"x"in p&&(l+=p.x),"y"in p&&(m+=p.y);("M"==q||"m"==q)&&(e=l,f=m)}a.setAttribute("d",a.getAttribute("d").replace(/Z/g,"z"))},dynamicSortMultiple:function(){var a=function(a){return function(b,c){return b[a]>c[a]?1:b[a]<c[a]?-1:0}},b=arguments;return function(c,d){for(var e=0,f=0,g=b.length;0===f&&g>e;)f=a(b[e])(c,d),e++;return f}},swapObjPropValue:function(a,b,c){var d=angular.copy(a[b]);a[b]=a[c],a[c]=d},datediff:function(a,b){var c={inHours:function(a,b){var c=b.getTime(),d=a.getTime();return parseInt((c-d)/36e5)},inDays:function(a,b){var c=b.getTime(),d=a.getTime();return parseInt((c-d)/864e5)},inWeeks:function(a,b){var c=b.getTime(),d=a.getTime();return parseInt((c-d)/6048e5)},inMonths:function(a,b){var c=a.getFullYear(),d=b.getFullYear(),e=a.getMonth(),f=b.getMonth();return f+12*d-(e+12*c)},inYears:function(a,b){return b.getFullYear()-a.getFullYear()}};return c.inYears(a,b)>1?c.inYears(a,b)+" years ago":c.inMonths(a,b)>1?c.inMonths(a,b)+" months ago":c.inWeeks(a,b)>1?c.inWeeks(a,b)+" weeks ago":c.inDays(a,b)>1?c.inDays(a,b)+" days ago":c.inHours(a,b)>1?c.inHours(a,b)+" hours ago":" just now"},arrays_equal:function(a,b){return!(b>a||a>b)},splitPrompts:function(a){return _.flatten(_.map(a,function(a,b){var c=a.prompt.split("");return _.map(c,function(c,d){return{prompt:c,promptindex:b,promptlen:a.prompt.length,letterindex:d}})}),!0)},rgbStringToHslString:function(a){var b=/rgb\((\d+),\s*(\d+),\s*(\d+)\)/,c=b.exec(a),d=a;if(c){d=this.rgbToHsl(c[1],c[2],c[3]);var e="hsl("+parseInt(360*d[0])+","+parseInt(100*d[1])+"%,"+parseInt(100*d[2])+"%)";return e}return d},hslStringToRgbString:function(a){var b=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/,c=b.exec(a),d=a;if(c){d=this.hslToRgb(c[1]/360,c[2]/100,c[3]/100);var e="rgb("+parseInt(255*d[0])+","+parseInt(255*d[1])+","+parseInt(255*d[2])+")";return e}return d},rgbToHsl:function(a,b,c){a/=255,b/=255,c/=255;var d,e,f=Math.max(a,b,c),g=Math.min(a,b,c),h=(f+g)/2;if(f==g)d=e=0;else{var i=f-g;switch(e=h>.5?i/(2-f-g):i/(f+g),f){case a:d=(b-c)/i+(c>b?6:0);break;case b:d=(c-a)/i+2;break;case c:d=(a-b)/i+4}d/=6}return[d,e,h]},hslToRgb:function(a,b,c){function d(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}var e,f,g;if(0==b)e=f=g=c;else{var h=.5>c?c*(1+b):c+b-c*b,i=2*c-h;e=d(i,h,a+1/3),f=d(i,h,a),g=d(i,h,a-1/3)}return[e,f,g]},randomColor:function(){var a=.618033988749895,b=Math.random();return function(){return b+=a,b%=1,"hsl("+parseInt(360*b)+",50%,60%)"}},interpolateHSL:function(a,b,c){var d=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/,e=d.exec(String(a)),f=d.exec(String(b)),g=_.map(new Array(c),function(a,b){var d=Math.min(f[1],e[1])+parseInt(b/c*Math.abs(f[1]-e[1])),g=Math.min(f[2],e[2])+parseInt(b/c*Math.abs(f[2]-e[2])),h=Math.min(f[3],e[3])+parseInt(b/c*Math.abs(f[3]-e[3]));return"hsl("+d+", "+g+"%, "+h+"%)"});return g.concat(angular.copy(g).reverse()).join(";")},decStep:function(a,b){if(a){var c=parseFloat(a.substring(0,a.length-1));c=0>=c?.1:c}else c=.1;return b?(c=c-b>0?c-b:0,Math.round(100*c)/100+"s"):Math.round(.75*c*100)/100+"s"},incStep:function(a,b){if(a){var c=parseFloat(a.substring(0,a.length-1));c=c>=60?60:0>=c?.1:c}else c=.1;return b?Math.round(100*(c+b))/100+"s":Math.round(1.25*c*100)/100+"s"},anotherFunc:function(){}}}),angular.module("lightgalaApp").directive("ads",function(){return{restrict:"A",template:'<div ng-include="contentUrl"></div>',link:function(a,b,c){},controller:function(){(adsbygoogle=window.adsbygoogle||[]).push({})}}}),angular.module("lightgalaApp").directive("rgbHsl",["utilService",function(a){return{require:"ngModel",link:function(b,c,d,e){e.$parsers.push(function(b){var c=/rgb\((\d+),\s*(\d+),\s*(\d+)\)/,d=c.exec(b),e=b;if(d){e=a.rgbToHsl(d[1],d[2],d[3]);var f="hsl("+parseInt(360*e[0])+","+parseInt(100*e[1])+"%,"+parseInt(100*e[2])+"%)";return f}return e}),e.$formatters.push(function(b){var c=/hsl\((\d+),\s*([\d.]+)%,\s*([\d.]+)%\)/,d=c.exec(b),e=b;if(d){e=a.hslToRgb(d[1]/360,d[2]/100,d[3]/100);var f="rgb("+parseInt(255*e[0])+","+parseInt(255*e[1])+","+parseInt(255*e[2])+")";return f}return e})}}}]).directive("popOver",["$compile","utilService","toolService","lightAnimService",function(a,b,c,d){var e="<table class='table table-condensed small anim-settings'><tr><th><small style='white-space: nowrap;display:inline-block'><span class='glyphicon icon-plus2' ng-click=setAnimPlusFiveSecond(decor_line_id)></span>{{anim_start_second}}<span class='glyphicon icon-minus' ng-click=setAnimMinusFiveSecond(decor_line_id)></span></small></th><th>set</th><th>seg</th><th>start</th><th>pattern</th><th>dur</th><th>delay</th><th>smooth</th></tr>	    <tr ng-repeat='anim in animations | filter:selectAnimation(decor_line_id)' decor_line_id='{{anim.decor_line_id}}' style='background-color:{{anim.config.stopcolor2}}' class={{anim.active?'anim-active':''}} ng-mouseover='mouseOverAnim(anim.anim_id)' ng-mouseout='mouseLeaveAnim(anim.anim_id)'>	      <td><small><span class='glyphicon glyphicon-trash' anim-id='{{anim.anim_id}}' ng-click='delAnimation(anim.anim_id)'></span></small></td><td>{{anim.set}}</td><td>{{anim.segment}}</td><td><input type='number' ng-model='anim.start_second' ng-pattern='/^[\\d.]+$/' class='anim-input input-sm' /></td>	      <td ng-switch='anim.config.colorname'><div ng-switch-when='rgb'><span class='glyphicon icon-palette' style='background-color:{{anim.config.stopcolor1}}; font-size: 14px' rgb-hsl colorpicker='rgb' colorpicker-close-on-select colorpicker-position='bottom' ng-model='anim.config.stopcolor1'/><span class='glyphicon icon-palette' style='background-color:{{anim.config.stopcolor2}}; font-size: 14px' rgb-hsl colorpicker='rgb' colorpicker-close-on-select colorpicker-position='bottom' type='text' ng-model='anim.config.stopcolor2'/></div><input ng-switch-default ng-model='anim.config.pattern_code' ng-pattern='/^[01]+$/' class='anim-input input-sm' /></td>	      <td><input ng-model='anim.config.dur' ng-pattern='/^[\\d.]+s$/' class='anim-input input-sm' /></td>	      <td><input ng-model='anim.config.begin' ng-pattern='/^[\\d.]+s$/' class='anim-input input-sm' /></td>	      <td><select ng-model='anim.config.calcmode' ng-options='x.value as x.text for x in calcmodes' class='anim-input' /></td>	    </tr>	  </table>",f=function(a){var b="";switch(a){case"animations":b=e}return b};return{restrict:"A",transclude:!0,template:"<span ng-transclude></span>",link:function(c,e,g){c.decor_line_id=g.decorLineId,c.calcmodes=[{value:"discrete",text:"N"},{value:"",text:"Y"}],c.selectAnimation=function(a){return function(b){return a?b.decor_line_id==a:!1}},c.delAnimation=function(a){var d=b.getArrayIndexWithPropertyEqualTo(c.animations,"anim_id",a);c.animations.splice(d,1)},c.setAnimPlusFiveSecond=function(a){var b=_.filter(c.animations,function(b){return b.decor_line_id==a&b.start_second==c.anim_start_second+5});if(0==b.length){var b=angular.copy(_.filter(c.animations,function(b){return b.decor_line_id==a&b.start_second==c.anim_start_second}));_.forEach(b,function(b){d.getAnim().initialize(c.animations,a,b.segment,b.set,b.color,b.start_second+5,c.defs[0].attributes)})}c.anim_start_second+=5},c.setAnimMinusFiveSecond=function(a){var b=_.filter(c.animations,function(b){return b.decor_line_id==a&b.start_second==c.anim_start_second-5});if(0==b.length){var b=angular.copy(_.filter(c.animations,function(b){return b.decor_line_id==a&b.start_second==c.anim_start_second}));_.forEach(b,function(b){d.getAnim().initialize(c.animations,a,b.segment,b.set,b.color,b.start_second-5,c.defs[0].attributes)})}c.anim_start_second-=5},c.mouseOverAnim=function(a){var b=_.find(c.animations,function(b){return b.anim_id==a});b&&d3.select("svg").select("g[decor_line_id='"+b.decor_line_id+"']").selectAll("g[segment='"+b.segment+"'][set='"+b.set+"'][bulbcolor='"+b.color+"']").selectAll(".click-capture").style("visibility","visible").classed("highlighted",!0)},c.mouseLeaveAnim=function(a){var b=_.find(c.animations,function(b){return b.anim_id==a});b&&d3.select("svg").select("g[decor_line_id='"+b.decor_line_id+"']").selectAll("g[segment='"+b.segment+"'][set='"+b.set+"'][bulbcolor='"+b.color+"']").selectAll(".click-capture").style("visibility","hidden").classed("highlighted",!1)};var h;if(c.animations){var i=f("animations");h=a(i)(c)}var j={content:h,placement:"bottom",html:!0,title:"animation settings"};$(e).popover(j).on("show.bs.popover",function(){c.anim_start_second=0,$("[data-original-title][decor_line_id!="+c.decor_line_id+"]").popover("hide"),$(this).data("bs.popover").tip().css("max-width","360px")})},scope:{animations:"=",current_config:"=",selectTool:"&",anim_start_second:"=animstartsecond",defs:"="}}}]),angular.module("lightgalaApp").directive("audiovisual",function(){return{restrict:"EA",templateUrl:"../../partials/audiovisual.html",link:function(a,b,c){}}}),angular.module("lightgalaApp").directive("comments",function(){return{restrict:"A",template:"",link:function(a,b,c){},controller:function(){var a="lightgala-comments";!function(){var b=document.createElement("script");b.type="text/javascript",b.async=!0,b.src="//"+a+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(b)}()}}}),angular.module("lightgalaApp").directive("links",function(){return{restrict:"EA",templateUrl:"../../partials/links.html",link:function(a,b,c){}}}),angular.module("lightgalaApp").directive("mainDecor",["$q","$window","$http","$routeParams","$location","$alert","$modal","$rootScope","d3Service","decorsListService","decorService","decorDataService","lightSvgsService","lightService","lightAnimService","toolService","utilService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){return function(a,c,r){a.mode=r.mode,a.backgroundtext=r.prompt,a.trashurl="/img/trash.png",a.margins={left:14,right:14,top:10,bottom:10},a.init=function(){d.id?j.get({_id:d.id,mode:a.mode},function(b){b.with_app_data?a.data=b:(a.data=b,a.data.widgets=l.getAppData().widgets,a.data.tools=l.getAppData().tools,a.data.defs=l.getAppData().defs),a.decor_id=b._id,h.$broadcast("data_ready",{})},function(a){401===a.status&&(e.path("/login"),f({title:"Login required!",content:"Login required before editing decor.",placement:"top-right",type:"danger",duration:3}))}):(console.log("make a new decor"),h.$broadcast("data_ready",{})),d.template_id&&j.get({_id:d.template_id,mode:"edit_template"},function(b){a.data.decor.backgroundurl=b.decor.backgroundurl,a.data.decor.emailto=b.decor.user_id.fakedemail?"spearsear@gmail.com":b.decor.user_id.email,a.data.decor.address=b.decor.address,b.with_app_data?(a.data.widgets=b.widgets,a.data.tools=b.tools,a.data.tools=b.defs):(a.data.widgets=l.getAppData().widgets,a.data.tools=l.getAppData().tools,a.data.defs=l.getAppData().defs),h.$broadcast("data_ready",{}),console.log("using decor "+b._id+" as template")},function(a){401===a.status&&f({title:"Login required!",content:"Login required before editing decor.",placement:"top-right",type:"danger",duration:3})})};var s=a.$on("$locationChangeStart",function(b,c){if(a.current.animation.start&&(a.current.animation.start=!1,a.current.animation.night=!1),a.current.music.track&&(p.getTool("musictool").invoke().afterinvoke(a),a.current.music.track.destruct(),a.current.music.track=void 0,a.data.decor.mediaurl=void 0),"edit"===a.mode)if(a.keepDataInCache)l.setData(a.data);else{var d=g({template:"partials/exitdecor.html",show:!1,backdrop:"static",scope:a});a.dirty?d.$promise.then(d.show):(l.resetData(),s(),e.path(c)),b.preventDefault()}"play"===a.mode&&l.resetData(),l.resetAppData(),a.element_config=p.getTool("").current_config.reset()}),t=function(){a.$$phase||a.$apply()};q.addEvent(window,"resize",t),a.watchSVGWidth=q.onceFunc(function(){a.$watch(function(){return a.svg.node().clientWidth},function(b){a.width=b,a.height=b*a.data.decor.decor_aspect_ratio,b>0&&(a.renderBackground(),a.init_current())})}),a.$watch("data.decor.backgroundurl",function(b,c){var d=document.getElementsByClassName("mainpic")[0];d&&(d.clientWidth>0||d.parentNode.clientWidth)&&a.renderBackground()},!0),a.$watch("current.decor.line_id",function(b){var c=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",b);angular.isUndefined(c)||(a.selectWidget(a.data.decor.decor_lines[c].decor_line_type,!0),$("[data-original-title][decor_line_id!="+a.data.decor.decor_lines[c].decor_line_id+"]").popover("hide"))},!0),a.$watch("data.decor.num_inches_per_x_unit",function(b,c){if(b&&c)for(var d=0;d<a.data.decor.decor_lines.length;d++){for(var e=!1,f=0;f<a.data.decor.decor_lines[d].elements.length;f++){var g=n.getLight(a.data.decor.decor_lines[d].elements[f].light_type);if(g.size_scale_func){var h=g.size_scale_reverse_func(a.data.decor.decor_lines[d].elements[f].scale_factor,c);a.data.decor.decor_lines[d].elements[f].scale_factor=g.size_scale_func(h,b),e=!0}}e&&a.decor_line_element_update_func(a.data.decor.decor_lines[d].decor_line_id)}},!0),a.$watch("element_config",function(a){$(".tool").removeClass("currentSelectedGrey");for(var b in a){var c=p.getToolByConfigField(b,a[b]);$(".tool[name="+c.toolName+"]").addClass("currentSelectedGrey")}},!0),a.$watch("current.animation",function(c,d){if(c.night!=d.night){var e=_.find(a.data.tools,function(a){return"nighttool"==a.name});if(a.current.animation.night){e.icon_toggle=!0;a.svg.select("g.decor g.background").selectAll(".nightsky").data(["night"]).enter().append("rect").attr("class","nightsky").attr("x",a.margins.left).attr("y",a.margins.top).attr("width",a.width-a.margins.left-a.margins.right).attr("height",a.height-a.margins.top-a.margins.bottom).attr("opacity",0).attr("fill","url("+b.location+"#nightsky)").transition().duration(1e3).attr("opacity",1);d3.selectAll(".basicImage image").attr("filter","url(#darker)")}else e.icon_toggle=!1,a.svg&&a.svg.selectAll(".nightsky").transition().duration(1e3).attr("opacity",0).remove(),d3.selectAll(".basicImage image").attr("filter","")}if(c.start!=d.start){var f=_.find(a.data.tools,function(a){return"animatestarttool"==a.name});a.current.animation.start?(f.icon_toggle=!0,a.svg&&(a.animateStart(!0),a.selectTool("musicTool"))):(f.icon_toggle=!1,a.svg&&(a.animateStart(!1),a.current.music.playing&&a.selectTool("musicTool")))}},!0),a.$watch("current.music.playing",function(b,c){var d=_.find(a.data.tools,function(a){return"volumeonofftool"==a.name});a.current.music.track&&(d.icon_toggle=a.current.music.track.muted)}),a.animateStart=function(b){if(b)_.forEach(a.data.animations,function(a){a.start_second>0?a.active=!1:a.active=!0}),a.$$phase||a.$apply(),_.forEach(a.data.decor.decor_lines,function(b){a.decor_line_anim_enter_func(b.decor_line_id);var c=o.getAnim();c.start(_.filter(a.data.animations,function(a){return a.decor_line_id==b.decor_line_id}),function(c){_.forEach(a.data.animations.sort(q.dynamicSortMultiple("start_second","set","segment")),function(d){if(d.decor_line_id==b.decor_line_id)if(d.start_second==c)d.active=!0;else if(d.start_second<=c){var e=_.filter(a.data.animations,function(a){return a.color==d.color&&a.decor_line_id==b.decor_line_id&&a.start_second>d.start_second&&a.start_second<=c});0==e.length?d.active=!0:d.active=!1}else d.active=!1}),a.decor_line_anim_update_func(b.decor_line_id)},function(){},3)});else{var c=o.getAnim();c.stop(function(){})}u(b)};var u=function(b){a.svg.selectAll(".decor_line_element:not(.unlightable)").each(b?function(){var a=n.getLight(d3.select(this).data()[0].light_type);d3.select(this).call(a.turnon).call(a.flash).call(a.glow).call(a.castshadow).call(a.emitray)}:function(){var a=n.getLight(d3.select(this).data()[0].light_type);d3.select(this).call(a.turnoff).call(a.unglow).call(a.uncastshadow).call(a.unemitray)})};i.d3().then(function(d){a.d3=d;var e=b.d3,f=e||a.d3;m.loadAll(a.d3||e),a.showTraceCircleFromPointWithRadius=function(b,c){var d=a.zoomedPosition([b.x,b.y],!0);b={x:d[0],y:d[1]};var e=a.zoomedRadius(c,!0),f=a.svg.append("g").attr("class","tracecircle-g"),g=a.element_config.color?a.element_config.color:"orange";f.append("circle").attr("class","tracecircle").attr("stroke-width",1).attr("stroke","silver").attr("opacity",.1).attr("fill",g).attr("cx",b.x).attr("cy",b.y).attr("r",0).transition().duration(500).attr("r",e).each("start",function(){f.append("text").attr("x",b.x+e).attr("y",b.y).attr("fill",g).text(function(){if(a.data.decor.num_inches_per_x_unit){var b=c*a.data.decor.num_inches_per_x_unit;return 12>b?"|<-"+Math.round(100*b)/100+" inches":"|<-"+Math.round(b/12*100)/100+" feet"}})}).transition().duration(1e3).attr("r",0).each("end",function(){f.remove()})},a.showTraceLineFromPoint=function(){var b=[].slice.call(arguments,0),c=b[0],d=b[1]?b[1]:[0,0],e=b[2]?b[2]:!1,g=a.svg.select("g[decor_line_id='"+a.current.decor.line_id+"']").select("g.traceline-g");null==g.node()&&(g=a.svg.select("g[decor_line_id='"+a.current.decor.line_id+"']").append("g").attr("class","traceline-g"));var h=g.append("line").classed("traceline",!0).attr("x1",c[0]+d[0]).attr("y1",c[1]+d[1]).attr("x2",c[0]+d[0]).attr("y2",c[1]+d[1]).attr("x_offset",d[0]).attr("y_offset",d[1]);g.append("text"),g.moveToBack(),a.svg.on("mousemove",function(){var b=f.mouse(this);b=a.zoomedPosition(b);var d,i=a.element_config.color?a.element_config.color:"orange";d=e?g.selectAll(".traceline"):h,d.each(function(){var d=parseFloat(f.select(this).attr("x_offset"))*a.element_config.set_scale_factor,e=parseFloat(f.select(this).attr("y_offset"))*a.element_config.set_scale_factor;f.select(this).attr("x2",b[0]+d).attr("y2",b[1]+e).attr("stroke-width",1).attr("stroke","silver").each(function(){g.select("text").attr("x",b[0]+d).attr("y",b[1]+e).attr("fill",i).text(function(){if(a.data.decor.num_inches_per_x_unit){var d=q.dist(c,b),e=d*a.data.decor.num_inches_per_x_unit;return 12>e?"|<-"+Math.round(100*e)/100+" inches":"|<-"+Math.round(e/12*100)/100+" feet"}})})})})},a.showTraceLinesFromPointForPoints=function(b,c){for(var d=(a.element_config.set_scale_factor,0);d<c.length;d++)a.showTraceLineFromPoint(b,[c[d][0]-b[0],c[d][1]-b[1]],!0)},a.delTraceLine=function(b){a.svg.select("g[decor_line_id='"+b+"']").selectAll(".traceline-g").remove(),a.svg.on("mousemove",null)},a.showRulerFromPoint=function(b,c){var d=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",b),e=k.getDecor(a.data.decor.decor_lines[d].decor_line_type).config(a.element_config),g=e.elementConfig.uselight.offset;a.axis_domain_width_feet=12,a.axis_background_data=[{id:1,side:"leftend",color:"orange",width:6},{id:2,side:"middle",color:"yellow",width:0},{id:3,side:"rightend",color:"orange",width:6}],a.axis=f.svg.axis().scale(f.scale.linear().domain([0,a.axis_domain_width_feet]).range([0,0])).orient("bottom").ticks(5).tickFormat(function(a){return a+"'"});var h=a.svg.select("g[decor_line_id='"+b+"']").append("g").classed("axis",!0).classed("measurementTape",!0).attr("x-start",a.xScale_reverse(c[0])).call(a.axis);h.attr("transform",function(){return"translate("+(c[0]+g.x)+","+(c[1]+g.y)+")"}).moveToBack(),a.svg.on("mousemove",function(){var c=f.mouse(this);c=a.zoomedPosition(c),a.extendRulerToPoint(b,c)})},a.extendRulerToPoint=function(b,c){var d=a.svg.select("g.decor g.decor_lines").select("g[decor_line_id='"+b+"']"),e=d.select("g.measurementTape"),f=Math.abs(a.xScale_reverse(c[0])-e.attr("x-start")),g=f/25>3?f/25:3;if(e){a.axis.scale().range([0,a.xScale(f)]),a.axis.ticks(g),a.axis_background_data[1].width=f,e.attr("ruler_width",f).call(a.axis);var h=e.node().getBBox();e.selectAll("rect.ruler-background").data(a.axis_background_data,function(a){return a.id}).enter().append("rect").attr("class","ruler-background").attr("opacity",function(a){return"leftend"==a.side|"rightend"==a.side?.7:.4}).attr("fill",function(a){return a.color}).attr("x",0).attr("y",h.y).attr("width",h.width).attr("height",h.height),e.selectAll("rect.ruler-background").data(a.axis_background_data,function(a){return a.id}).attr("x",function(b){return"middle"==b.side?0:"leftend"==b.side?h.x:h.x+a.xScale(f)}).attr("width",function(b){return a.xScale("middle"==b.side?f:b.width)}),a.data.decor.num_inches_per_x_unit=Math.round(12*a.axis_domain_width_feet/a.xScale(f)*1e3)/1e3,a.$$phase||a.$apply()}},a.cancelRuler=function(b){a.svg.on("mousemove",null)},$(document).bind("keyup",function(b){if(a.current.decor.line_id){if(27==b.keyCode)for(var c=0;c<a.data.decor.decor_lines.length;c++)a.delTraceLine(a.data.decor.decor_lines[c].decor_line_id);a.current.decor={},b.preventDefault()}}),a.renderLightGala=function(b){a.svg.select("g.decor g.decor_lines").selectAll("g.decor_line").remove(),a.svg.select("g.decor").append("g").attr("class","decor_lines"),a.xScale=f.scale.linear().domain([0,a.data.decor.decor_width]).range([0,a.width]),a.xScale_reverse=f.scale.linear().range([0,a.data.decor.decor_width]).domain([0,a.width]),a.yScale=f.scale.linear().domain([0,a.data.decor.decor_width*a.data.decor.decor_aspect_ratio]).range([0,a.height]),a.yScale_reverse=f.scale.linear().range([0,a.data.decor.decor_width*a.data.decor.decor_aspect_ratio]).domain([0,a.height]),a.rScale=f.scale.linear().domain([0,1]).range([0,1*a.width/a.data.decor.decor_width]),a.rScale_reverse=f.scale.linear().range([0,1]).domain([0,1*a.width/a.data.decor.decor_width]),a.dragged=!1,a.clear_all_decors=function(){for(var b=a.data.decor.decor_lines.length-1;b>=0;b--)a.data.decor.decor_lines[b].elements=[],a.decor_line_element_exit_func(a.data.decor.decor_lines[b].decor_line_id)},a.syncAnimsWithElements=function(b){var c=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",b);if(!c)return!1;for(var d=_.unique(_.map(a.data.decor.decor_lines[c].elements,function(b){return{decor_line_id:a.data.decor.decor_lines[c].decor_line_id,segment:b.segment,set:b.set,color:b.color}})),e=a.data.animations.length-1;e>=0;e--){var f=a.data.animations[e];if(f.decor_line_id==b){var g={decor_line_id:f.decor_line_id,segment:f.segment,set:f.set,color:f.color},h={decor_line_id:f.decor_line_id,segment:f.segment,set:f.set};_.find(d,function(a){var b={decor_line_id:a.decor_line_id,segment:a.segment,
set:a.set};return _.isEqual(g,a)||_.isEqual(h,b)&&"random"==a.color})||a.data.animations.splice(e,1)}}},a.decor_line_exit_func=function(){return a.svg.select("g.decor g.decor_lines").selectAll(".decor_line").data(a.data.decor.decor_lines,function(a){return a.decor_line_id}).exit().remove()},a.decor_line_element_exit_func=function(b){var c=a.svg.select("g.decor g.decor_lines").select("g[decor_line_id='"+b+"']"),d=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",b);c.selectAll("g.decor_line_element[decor_line_id='"+b+"']").data(a.data.decor.decor_lines[d].elements,function(b){return a.data.decor.decor_lines[d].decor_line_id+"_"+b.id}).exit().transition().duration(500).attr("transform",function(b){var c,d,e=f.select(this).select(".outline").node(),g=e.getBBox(),h=a.rScale(3*b.scale_factor),i=parseInt(f.select(this).attr("x")),j=parseInt(f.select(this).attr("y")),k=b.scale_factor;return i>=a.margins.left+k&&i<=a.width-a.margins.right-k&&j>=a.margins.top+k&&j<=a.height-a.margins.bottom-k?(c=Math.random()*g.width*4,d=Math.random()*g.height*4):(c=i-b.x,d=j<a.margins.top?-Math.random()*g.height*4-b.y:Math.random()*g.height*4+j),"translate("+a.xScale(b.x-a.xScale_reverse(g.x+g.width/2)-a.xScale_reverse(g.x+g.width/2)*(h-1)+c)+","+a.yScale(b.y-a.yScale_reverse(g.y+g.height/2)-a.yScale_reverse(g.y+g.height/2)*(h-1)+d)+") scale("+h+") rotate("+a.element_config.rotate()+","+(g.x+g.width/2)+","+(g.y+g.height/2)+")"}).ease("cubic").remove(),0==a.data.decor.decor_lines[d].elements.length&&(a.data.decor.decor_lines.splice(d,1),a.current.decor={},a.decor_line_exit_func(),a.delTraceLine(b)),a.syncAnimsWithElements(b),a.$$phase||a.$apply()},a.decor_line_element_update_func=function(b){a.decor_line_anim_enter_func(b);var c=a.svg.select("g.decor g.decor_lines").select("g[decor_line_id='"+b+"']"),d=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",b);c.selectAll("g.decor_line_element[decor_line_id='"+b+"']").data(a.data.decor.decor_lines[d].elements,function(b){return a.data.decor.decor_lines[d].decor_line_id+"_"+b.id}).attr("set",function(a){return a.set}).attr("segment",function(a){return a.segment}).attr("group",function(a){return a.group}).each(function(b){Object.defineProperty(a.element_config,"light_type",{value:b.light_type,writable:!0,enumerable:!0}),Object.defineProperty(a.element_config,"light_subtype",{value:b.light_subtype,writable:!0,enumerable:!0}),Object.defineProperty(a.element_config,"color",{value:b.color,writable:!0,enumerable:!0}),Object.defineProperty(a.element_config,"rotate_degree",{value:b.rotate_degree,writable:!0,enumerable:!0}),Object.defineProperty(a.element_config,"scale_factor",{value:b.scale_factor,writable:!0,enumerable:!0}),f.select(this).call(k.getDecor(a.data.decor.decor_lines[d].decor_line_type).config(a.element_config).elementUpdateFunc()).classed("decor_line_element",!0).classed("unbreakable",b.light_unbreakable).classed("unlightable",b.light_unlightable).classed("unflashable",b.light_unflashable),f.select(this).classed("basicLight")&&f.select(this).attr("bulbcolor",function(a){return f.select(this).select(".bulb").attr("bulbcolor")})}).attr("x",function(b){return a.xScale(b.x)}).attr("y",function(b){return a.yScale(b.y)}).attr("transform",function(b){var c=f.select(this).select(".outline").node(),d=c.getBBox(),e=a.rScale(b.scale_factor);return"translate("+a.xScale(b.x-a.xScale_reverse(d.x+d.width/2)-a.xScale_reverse(d.x+d.width/2)*(e-1))+","+a.yScale(b.y-a.yScale_reverse(d.y+d.height/2)-a.yScale_reverse(d.y+d.height/2)*(e-1))+") scale("+e+") rotate("+a.element_config.rotate(b.rotate_degree)+","+(d.x+d.width/2)+","+(d.y+d.height/2)+")"}),a.syncAnimsWithElements(b)},a.decor_line_enter_func=function(){a.svg.select("g.decor g.decor_lines").selectAll(".decor_line").data(a.data.decor.decor_lines,function(a){return a.decor_line_id}).enter().append("g").attr("decor_line_id",function(a){return a.decor_line_id}).attr("class","decor_line")},a.decor_line_anim_enter_func=function(b){a.svg.select("g.decor g.decor_lines g.decor_line[decor_line_id='"+b+"']").selectAll("g.anim").remove(),a.svg.select("g.decor g.decor_lines g.decor_line[decor_line_id='"+b+"']").selectAll("g.anim").data(_.filter(a.data.animations,function(a){return a.decor_line_id==b&&a.active}),function(a){return a.decor_line_id+"-"+a.segment+"-"+a.set+"-"+a.color}).enter().append("g").attr("decor_line_id",function(a){return a.decor_line_id}).attr("class","anim").attr("colorname",function(a){return a.color}).attr("segment",function(a){return a.segment}).attr("set",function(a){return a.set}).attr("start-second",function(a){return a.start_second}).each(function(a){var b=f.select(this),c=o.getAnim();b.call(c.install_lighton).call(c.install_lightoff).call(c.install_lightflash)}),a.svg.select("g.decor g.decor_lines g.decor_line[decor_line_id='"+b+"']").selectAll("g.decor_line_element:not(.unlightable)").each(function(){var a=n.getLight(f.select(this).data()[0].light_type);f.select(this).call(a.unemitray).call(a.emitray)})},a.decor_line_anim_update_func=function(b){a.svg.select("g.decor g.decor_lines g.decor_line[decor_line_id='"+b+"']").selectAll("g.anim").data(_.filter(a.data.animations,function(a){return a.decor_line_id==b&&a.active}),function(a){return a.decor_line_id+"-"+a.segment+"-"+a.set+"-"+a.color}).attr("colorname",function(a){return a.color}).attr("segment",function(a){return a.segment}).attr("set",function(a){return a.set}).attr("start-second",function(a){return a.start_second}).each(function(a){var b=f.select(this),c=o.getAnim();b.call(c.update_lighton).call(c.update_lightoff).call(c.update_lightflash)}),a.svg.select("g.decor g.decor_lines g.decor_line[decor_line_id='"+b+"']").selectAll("g.decor_line_element:not(.unlightable)").each(function(){var a=n.getLight(f.select(this).data()[0].light_type);f.select(this).call(a.unemitray).call(a.emitray)})},a.decor_line_element_enter_func=function(b){a.decor_line_enter_func(),a.decor_line_anim_enter_func(b);var c=a.svg.select("g.decor g.decor_lines").select("g[decor_line_id='"+b+"']"),d=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",b),e=k.getDecor(a.data.decor.decor_lines[d].decor_line_type).config(a.element_config);if(c.selectAll("g.decor_line_element[decor_line_id='"+b+"']").data(a.data.decor.decor_lines[d].elements,function(b){return a.data.decor.decor_lines[d].decor_line_id+"_"+b.id}).enter().append("g").attr("decor_line_id",a.data.decor.decor_lines[d].decor_line_id).attr("decor_line_element_id",function(a){return a.id}).attr("id",function(b){return"id_"+a.data.decor.decor_lines[d].decor_line_id+"_"+b.id}).attr("set",function(a){return a.set}).attr("segment",function(a){return a.segment}).attr("group",function(a){return a.group}).each(function(b){Object.defineProperty(a.element_config,"light_type",{value:b.light_type,writable:!0,enumerable:!0}),Object.defineProperty(a.element_config,"light_subtype",{value:b.light_subtype,writable:!0,enumerable:!0}),Object.defineProperty(a.element_config,"color",{value:b.color,writable:!0,enumerable:!0}),Object.defineProperty(a.element_config,"rotate_degree",{value:b.rotate_degree,writable:!0,enumerable:!0}),Object.defineProperty(a.element_config,"scale_factor",{value:b.scale_factor,writable:!0,enumerable:!0}),f.select(this).call(k.getDecor(a.data.decor.decor_lines[d].decor_line_type).config(a.element_config).elementMakeFunc()).classed("decor_line_element",!0).classed("unbreakable",b.light_unbreakable).classed("unlightable",b.light_unlightable).classed("unflashable",b.light_unflashable),f.select(this).classed("basicLight")&&f.select(this).attr("bulbcolor",function(a){return f.select(this).select(".bulb").attr("bulbcolor")})}).on("mouseenter",function(){f.select(this).attr("transform",function(b){var c=f.select(this).select(".outline").node(),d=c.getBBox(),e=a.rScale(3*b.scale_factor);return"translate("+a.xScale(b.x-a.xScale_reverse(d.x+d.width/2)-a.xScale_reverse(d.x+d.width/2)*(e-1))+","+a.yScale(b.y-a.yScale_reverse(d.y+d.height/2)-a.yScale_reverse(d.y+d.height/2)*(e-1))+") scale("+e+") rotate("+a.element_config.rotate()+","+(d.x+d.width/2)+","+(d.y+d.height/2)+")"})}).on("mousemove",function(b){if(a.dragged&&!f.select(this).classed("dragging")&&!f.select(this).classed("unbreakable")){var c=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",f.select(this).attr("decor_line_id")),d=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines[c].elements,"id",f.select(this).attr("decor_line_element_id"));if(void 0!=d){var e=_.filter(a.data.decor.decor_lines[c].elements,function(b){return b.decor_line_id==a.data.decor.decor_lines[c].elements[d].decor_line_id&&b.segment==a.data.decor.decor_lines[c].elements[d].segment&&b.set==a.data.decor.decor_lines[c].elements[d].set&&b.color==a.data.decor.decor_lines[c].elements[d].color});1==e.length&&_.remove(a.data.animations,function(b){return b.decor_line_id==a.data.decor.decor_lines[c].decor_line_id&&b.segment==a.data.decor.decor_lines[c].elements[d].segment&&b.set==a.data.decor.decor_lines[c].elements[d].set&&b.color==a.data.decor.decor_lines[c].elements[d].color}),a.data.decor.decor_lines[c].elements.splice(d,1),a.decor_line_element_exit_func(f.select(this).attr("decor_line_id"))}}}).on("mouseleave",function(){f.select(this).attr("transform",function(b){var c=f.select(this).select(".outline").node(),d=c.getBBox(),e=a.rScale(b.scale_factor);return"translate("+a.xScale(b.x-a.xScale_reverse(d.x+d.width/2)-a.xScale_reverse(d.x+d.width/2)*(e-1))+","+a.yScale(b.y-a.yScale_reverse(d.y+d.height/2)-a.yScale_reverse(d.y+d.height/2)*(e-1))+") scale("+e+") rotate("+a.element_config.rotate()+","+(d.x+d.width/2)+","+(d.y+d.height/2)+")"})}).on("click",function(){if(f.event.stopPropagation(),"play"!==a.mode&&a.data.decor.backgroundurl){if(a.current.operation.type=angular.equals(a.current.decor,{})?"set":"segment",a.dragged)a.dragged=!1,f.select(this).classed("dragging",!1),a.current.decor={};else{var b=a.current.decor;a.current.decor={line_id:f.select(this).attr("decor_line_id"),line_element_id:"set"!=a.current.operation.type?f.select(this).attr("decor_line_element_id"):null},a.$apply()}var c=q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",f.select(this).attr("decor_line_id"));if(!angular.isUndefined(c)&&null!==c){b.line_element_id&&a.current.decor.line_element_id&&b.line_id==a.current.decor.line_id&&e.decor_line_end_at(a,[f.select(this).attr("x"),f.select(this).attr("y"),f.select(this).attr("segment"),f.select(this).attr("group")]);var d=a.current.decor?q.getArrayIndexWithPropertyEqualTo(a.data.decor.decor_lines,"decor_line_id",a.current.decor.line_id):void 0;if(void 0!=d){a.svg.selectAll("g.decor_line_element[decor_line_id='"+a.data.decor.decor_lines[d].decor_line_id+"']:not(.unlightable)").each(function(){var a=n.getLight(f.select(this).data()[0].light_type);f.select(this).call(a.turnon).call(a.flash).call(a.glow)}),a.svg.selectAll("g.decor_line_element:not([decor_line_id='"+a.data.decor.decor_lines[d].decor_line_id+"']):not(.unlightable)").each(function(){var a=n.getLight(f.select(this).data()[0].light_type);f.select(this).call(a.turnoff)});var g=a.data.decor.decor_lines[d].elements,h=g[g.length-1],i=h?[a.xScale(h.x),a.yScale(h.y)]:void 0;i&&e.decor_line_start_at(a,null).decor_line_trace_at(a,i)}else a.svg.selectAll("g.decor_line_element:not(.unlightable)").each(function(){var a=n.getLight(f.select(this).data()[0].light_type);f.select(this).call(a.turnoff)});return!1}}}).call(e.decor_line_element_drag(a)).attr("x",function(b){return a.xScale(b.x)}).attr("y",function(b){return a.yScale(b.y)}).attr("transform",function(b){var c=f.select(this).select(".outline").node(),d=c.getBBox(),e=a.rScale(b.scale_factor);return"translate("+a.xScale(b.x-a.xScale_reverse(d.x+d.width/2)-a.xScale_reverse(d.x+d.width/2)*(e-1))+","+a.yScale(b.y-a.yScale_reverse(d.y+d.height/2)-a.yScale_reverse(d.y+d.height/2)*(e-1))+") scale("+e+") rotate("+a.element_config.rotate(b.rotate_degree)+","+(d.x+d.width/2)+","+(d.y+d.height/2)+")"}),"measurementScaling"==a.data.decor.decor_lines[d].decor_line_type&&2==a.data.decor.decor_lines[d].elements.length&&null==c.select(".measurementTape").node()){var g=[a.xScale(a.data.decor.decor_lines[d].elements[0].x),a.yScale(a.data.decor.decor_lines[d].elements[0].y)];a.showRulerFromPoint(b,g);var h=[a.xScale(a.data.decor.decor_lines[d].elements[1].x),a.yScale(a.data.decor.decor_lines[d].elements[1].y)];a.extendRulerToPoint(b,h),a.cancelRuler(b)}"measurementScaling"==a.data.decor.decor_lines[d].decor_line_type&&"play"==a.mode&&a.toggleDecorLine(a.data.decor.decor_lines[d].decor_line_id)};for(var c=0;c<a.data.decor.decor_lines.length;c++)a.decor_line_element_enter_func(a.data.decor.decor_lines[c].decor_line_id);a.svg.on("click",h),a.svg.on("mouseup",g)},window.onmousemove=function(b){b||(b=window.event),a.setZoomable(b.shiftKey?!0:!1)};var g=function(){a.setZoomable(!1)},h=function(){if("play"!==a.mode){if(!a.data.decor.backgroundurl)return void a.selectTool("cameratool");if(f.event.shiftKey)return void a.setZoomable(!0);var b=f.mouse(this);if(b=a.zoomedPosition(b),r_size=4,b[0]>=a.margins.left+r_size&&b[0]<=a.width-a.margins.right-r_size&&b[1]>=a.margins.top+r_size&&b[1]<=a.height-a.margins.bottom-r_size){var c=k.getDecor(a.current.widget.line_type).config(a.element_config);c.decor_line_start_at(a,[b[0],b[1],null]).decor_line_trace_at(a,b)}}};a.zoomedPosition=function(b,c){return a.current.operation&&a.current.operation.translate&&a.current.operation.scale?c?[a.current.operation.translate[0]+b[0]*a.current.operation.scale,a.current.operation.translate[1]+b[1]*a.current.operation.scale]:[(b[0]-a.current.operation.translate[0])/a.current.operation.scale,(b[1]-a.current.operation.translate[1])/a.current.operation.scale]:b},a.zoomedRadius=function(b,c){return a.current.operation&&a.current.operation.scale?c?b*a.current.operation.scale:b/a.current.operation.scale:b},a.setZoomable=function(){function b(){return a.svg.select("g.decor").attr("transform","translate("+f.event.translate+")scale("+f.event.scale+")"),a.current.operation.translate=f.event.translate,a.current.operation.scale=f.event.scale,!1}var c=Array.prototype.slice.call(arguments,0);c.length>0&&(a.zoomable=c[0]),a.svg&&(a.zoomable?(a.zoomable=!0,a.svg.call(f.behavior.zoom().scaleExtent([1,10]).on("zoom",b)).on("dblclick.zoom",null).on("click",null)):(a.zoomable=!1,a.svg.on("mousedown.zoom",null),a.svg.on("mousemove.zoom",null),a.svg.on("dblclick.zoom",null),a.svg.on("touchstart.zoom",null),a.svg.on("wheel.zoom",null),a.svg.on("mousewheel.zoom",null),a.svg.on("MozMousePixelScroll.zoom",null),a.svg.on("click",h)))},a.renderBackground=function(){if(angular.isObject(f)&&f.hasOwnProperty("version")){a.svg&&f.select(c[0]).selectAll("svg").remove();var b=f.select(c[0]).append("svg");if(a.svg_defs&&b.node().appendChild(a.svg_defs),b.attr("width",700).attr("class","mainpic"),a.svg=b,a.width=document.getElementsByClassName("mainpic")[0].getBoundingClientRect().width,a.height=a.width*a.data.decor.decor_aspect_ratio,b.attr("width",a.width).attr("height",a.height),b.append("g").attr("class","decor"),a.data.decor.backgroundurl)a.svg.select("g.decor").select("g.background").selectAll("text").data([]).exit().remove(),a.svg.select("g.decor").append("g").attr("class","background").selectAll("image").data([0]).enter().append("svg:image").attr("xlink:href",a.data.decor.backgroundurl).attr("x",a.margins.left).attr("y",a.margins.top).attr("width",a.width-a.margins.left-a.margins.right).attr("height",a.height-a.margins.top-a.margins.bottom).attr("preserveAspectRatio","none").attr("class","background");else{var d=function(b,c){f.select(this).transition().duration(3e3).attrTween("transform",function(){var c=(a.width-a.margins.left-a.margins.right)/2+22*(b.letterindex-b.promptlen/2),d=(a.height-a.margins.top-a.margins.bottom)/2+42*b.promptindex,e="translate("+(Math.random()+.5)*c+","+(Math.random()+.5)*d+")",g="translate("+c+","+d+")";return f.interpolateString(e+" scale("+1.5*Math.random()+") rotate(0)",g+" scale(1) rotate(720)")}).each("end",a.getPrompt().cycle?d:function(){})};a.svg.select("g.decor").append("g").attr("class","background").selectAll("text").data(q.splitPrompts([{prompt:a.backgroundtext},{prompt:"1i8h+8@1@.com"}])).enter().append("text").text(function(a){return a.prompt}).attr("text-anchor","middle").attr("style","font-size:42px;font-style:normal;font-weight:normal;fill-opacity:1;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;font-family:sans-serif").attr("fill",q.randomColor()).each(d)}a.renderLightGala(a.data.decor.decor_lines),a.svg.select("g.decor").append("g").attr("class","foreground")}},f.xml("/js/services/svgs/defs.svg","image/svg+xml",function(b,c){return b?void console.log(b):(a.svg_defs=c.getElementsByTagName("defs")[0],void a.renderBackground())}),a.renderBackground(),a.init()})}}]),angular.module("lightgalaApp").directive("playtools",function(){return{restrict:"EA",templateUrl:"../../partials/playtools.html",link:function(a,b,c){a.show_tool_options=!1,a.toggleToolOptions=function(b){var c=_.findIndex(a.data.tools,function(a){return a.name==b});c>=0&&a.data.tools[c].options.length>0&&(a.data.tools[c].show_options=!a.data.tools[c].show_options)}}}}),angular.module("lightgalaApp").directive("rain",["$document",function(a){return{restrict:"EA",templateUrl:"../../partials/weather.html",controller:["$scope","$element","$timeout",function(b,c,d){d(function(){function b(a,c){if(this===window)return new b(a);this.img=a.image;var d={opacity:1,blur:10,crop:[0,0,this.img.naturalWidth,this.img.naturalHeight],enableSizeChange:!0,parentElement:document.getElementsByTagName("body")[0],fps:30,fillStyle:"#8ED6FF",enableCollisions:!0,gravityThreshold:3,gravityAngle:Math.PI/2,gravityAngleVariance:0,reflectionScaledownFactor:5,reflectionDropMappingWidth:200,reflectionDropMappingHeight:200,width:this.img.clientWidth,height:this.img.clientHeight,position:"absolute",top:0,left:0};for(var e in d)"undefined"==typeof a[e]&&(a[e]=d[e]);this.options=a,this.drops=[],this.canvas=c||this.prepareCanvas(),this.prepareBackground(),this.prepareGlass(),this.reflection=this.REFLECTION_MINIATURE,this.trail=this.TRAIL_DROPS,this.gravity=this.GRAVITY_NON_LINEAR,this.collision=this.COLLISION_SIMPLE,this.setRequestAnimFrame()}function c(a,b,c,d,e){this.x=Math.floor(b),this.y=Math.floor(c),this.r=Math.random()*e+d,this.rainyday=a,this.context=a.context,this.reflection=a.reflected}function d(){this.r=0,this.g=0,this.b=0,this.next=null}function e(a,b,c){this.resolution=c,this.xc=a,this.yc=b,this.matrix=new Array(a);for(var d=0;a+5>=d;d++){this.matrix[d]=new Array(b);for(var e=0;b+5>=e;++e)this.matrix[d][e]=new f(null)}}function f(a){this.drop=a,this.next=null}var g="http://www.w3.org/1999/xhtml",h=a[0].getElementsByTagNameNS(g,"canvas")[0];b.prototype.prepareCanvas=function(){var a=document.createElement("canvas");return a.style.position=this.options.position,a.style.top=this.options.top,a.style.left=this.options.left,a.width=this.options.width,a.height=this.options.height,this.options.parentElement.appendChild(a),this.options.enableSizeChange&&this.setResizeHandler(),a},b.prototype.setResizeHandler=function(){null!==window.onresize?window.setInterval(this.checkSize.bind(this),100):(window.onresize=this.checkSize.bind(this),window.onorientationchange=this.checkSize.bind(this))},b.prototype.checkSize=function(){var a=this.img.clientWidth,b=this.img.clientHeight,c=this.img.offsetLeft,d=this.img.offsetTop,e=this.canvas.width,f=this.canvas.height,g=this.canvas.offsetLeft,h=this.canvas.offsetTop;(e!==a||f!==b)&&(this.canvas.width=a,this.canvas.height=b,this.prepareBackground(),this.glass.width=this.canvas.width,this.glass.height=this.canvas.height,this.prepareReflections()),(g!==c||h!==d)&&(this.canvas.offsetLeft=c,this.canvas.offsetTop=d)},b.prototype.animateDrops=function(){this.addDropCallback&&this.addDropCallback();for(var a=this.drops.slice(),b=[],c=0;c<a.length;++c)a[c].animate()&&b.push(a[c]);this.drops=b,window.requestAnimFrame(this.animateDrops.bind(this))},b.prototype.setRequestAnimFrame=function(){var a=this.options.fps;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(b){window.setTimeout(b,1e3/a)}}()},b.prototype.prepareReflections=function(){this.reflected=document.createElement("canvas"),this.reflected.width=this.canvas.width/this.options.reflectionScaledownFactor,this.reflected.height=this.canvas.height/this.options.reflectionScaledownFactor;var a=this.reflected.getContext("2d");a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.reflected.width,this.reflected.height)},b.prototype.prepareGlass=function(){this.glass=document.createElement("canvas"),this.glass.width=this.canvas.width,this.glass.height=this.canvas.height,this.context=this.glass.getContext("2d")},b.prototype.rain=function(a,b){if(this.reflection!==this.REFLECTION_NONE&&this.prepareReflections(),this.animateDrops(),this.presets=a,this.PRIVATE_GRAVITY_FORCE_FACTOR_Y=.001*this.options.fps/25,this.PRIVATE_GRAVITY_FORCE_FACTOR_X=.001*(Math.PI/2-this.options.gravityAngle)*this.options.fps/50,this.options.enableCollisions){for(var d=0,f=0;f<a.length;f++)a[f][0]+a[f][1]>d&&(d=Math.floor(a[f][0]+a[f][1]));if(d>0){var g=Math.ceil(this.canvas.width/d),h=Math.ceil(this.canvas.height/d);this.matrix=new e(g,h,d)}else this.options.enableCollisions=!1}for(var f=0;f<a.length;f++)a[f][3]||(a[f][3]=-1);var i=0;this.addDropCallback=function(){var d=(new Date).getTime();if(!(b>d-i)){i=d;var e=this.canvas.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height),e.drawImage(this.background,0,0,this.canvas.width,this.canvas.height);for(var f,g=0;g<a.length;g++)if(a[g][2]>1||-1===a[g][3]){if(0!==a[g][3]){a[g][3]--;for(var h=0;h<a[g][2];++h)this.putDrop(new c(this,Math.random()*this.canvas.width,Math.random()*this.canvas.height,a[g][0],a[g][1]))}}else if(Math.random()<a[g][2]){f=a[g];break}f&&this.putDrop(new c(this,Math.random()*this.canvas.width,Math.random()*this.canvas.height,f[0],f[1])),e.save(),e.globalAlpha=this.options.opacity,e.drawImage(this.glass,0,0,this.canvas.width,this.canvas.height),e.restore()}}.bind(this)},b.prototype.putDrop=function(a){a.draw(),this.gravity&&a.r>this.options.gravityThreshold&&(this.options.enableCollisions&&this.matrix.update(a),this.drops.push(a))},b.prototype.clearDrop=function(a,b){var c=a.clear(b);if(c){var d=this.drops.indexOf(a);d>=0&&this.drops.splice(d,1)}return c},c.prototype.draw=function(){this.context.save(),this.context.beginPath();var a=this.r;if(this.r=.95*this.r,this.r<3)this.context.arc(this.x,this.y,this.r,0,2*Math.PI,!0),this.context.closePath();else if(this.colliding||this.yspeed>2){if(this.colliding){var b=this.colliding;this.r=1.001*(this.r>b.r?this.r:b.r),this.x+=b.x-this.x,this.colliding=null}var c=1+.1*this.yspeed;this.context.moveTo(this.x-this.r/c,this.y),this.context.bezierCurveTo(this.x-this.r,this.y-2*this.r,this.x+this.r,this.y-2*this.r,this.x+this.r/c,this.y),this.context.bezierCurveTo(this.x+this.r,this.y+c*this.r,this.x-this.r,this.y+c*this.r,this.x-this.r/c,this.y)}else this.context.arc(this.x,this.y,.9*this.r,0,2*Math.PI,!0),this.context.closePath();this.context.clip(),this.r=a,this.rainyday.reflection&&this.rainyday.reflection(this),this.context.restore()},c.prototype.clear=function(a){return this.context.clearRect(this.x-this.r-1,this.y-this.r-2,2*this.r+2,2*this.r+2),a?(this.terminate=!0,!0):this.y-this.r>this.rainyday.h||this.x-this.r>this.rainyday.w||this.x+this.r<0?!0:!1},c.prototype.animate=function(){if(this.terminate)return!1;var a=this.rainyday.gravity(this);if(!a&&this.rainyday.trail&&this.rainyday.trail(this),this.rainyday.options.enableCollisions){var b=this.rainyday.matrix.update(this,a);b&&this.rainyday.collision(this,b)}return!a||this.terminate},b.prototype.TRAIL_NONE=function(){},b.prototype.TRAIL_DROPS=function(a){(!a.trailY||a.y-a.trailY>=100*Math.random()*a.r)&&(a.trailY=a.y,this.putDrop(new c(this,a.x+(2*Math.random()-1)*Math.random(),a.y-a.r-5,Math.ceil(a.r/5),0)))},b.prototype.TRAIL_SMUDGE=function(a){var b=a.y-a.r-3,c=a.x-a.r/2+2*Math.random();0>b||0>c||this.context.drawImage(this.clearbackground,c,b,a.r,2,c,b,a.r,2)},b.prototype.GRAVITY_NONE=function(){return!0},b.prototype.GRAVITY_LINEAR=function(a){return this.clearDrop(a)?!0:(a.yspeed?(a.yspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(a.r),a.xspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(a.r)):(a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y,a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X),a.y+=a.yspeed,a.draw(),!1)},b.prototype.GRAVITY_NON_LINEAR=function(a){return this.clearDrop(a)?!0:(a.collided?(a.collided=!1,a.seed=Math.floor(a.r*Math.random()*this.options.fps),a.skipping=!1,a.slowing=!1):(!a.seed||a.seed<0)&&(a.seed=Math.floor(a.r*Math.random()*this.options.fps),a.skipping=a.skipping===!1?!0:!1,a.slowing=!0),a.seed--,a.yspeed?a.slowing?(a.yspeed/=1.1,a.xspeed/=1.1,a.yspeed<this.PRIVATE_GRAVITY_FORCE_FACTOR_Y&&(a.slowing=!1)):a.skipping?(a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y,a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X):(a.yspeed+=1*this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(a.r),a.xspeed+=1*this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(a.r)):(a.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y,a.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X),0!==this.options.gravityAngleVariance&&(a.xspeed+=(2*Math.random()-1)*a.yspeed*this.options.gravityAngleVariance),a.y+=a.yspeed,a.x+=a.xspeed,a.draw(),!1)},b.prototype.positiveMin=function(a,b){var c=0;return c=b>a?0>=a?b:a:0>=b?a:b,0>=c?1:c},b.prototype.REFLECTION_NONE=function(){this.context.fillStyle=this.options.fillStyle,this.context.fill()},b.prototype.REFLECTION_MINIATURE=function(a){var b=Math.max((a.x-this.options.reflectionDropMappingWidth)/this.options.reflectionScaledownFactor,0),c=Math.max((a.y-this.options.reflectionDropMappingHeight)/this.options.reflectionScaledownFactor,0),d=this.positiveMin(2*this.options.reflectionDropMappingWidth/this.options.reflectionScaledownFactor,this.reflected.width-b),e=this.positiveMin(2*this.options.reflectionDropMappingHeight/this.options.reflectionScaledownFactor,this.reflected.height-c),f=Math.max(a.x-1.1*a.r,0),g=Math.max(a.y-1.1*a.r,0);this.context.drawImage(this.reflected,b,c,d,e,f,g,2*a.r,2*a.r)},b.prototype.COLLISION_SIMPLE=function(a,b){for(var c,d=b;null!=d;){var e=d.drop;if(Math.sqrt(Math.pow(a.x-e.x,2)+Math.pow(a.y-e.y,2))<a.r+e.r){c=e;break}d=d.next}if(c){var f,g;a.y>c.y?(f=a,g=c):(f=c,g=a),this.clearDrop(g),this.clearDrop(f,!0),this.matrix.remove(f),g.draw(),g.colliding=f,g.collided=!0}},b.prototype.prepareBackground=function(){this.background=document.createElement("canvas"),this.background.width=this.canvas.width,this.background.height=this.canvas.height,this.clearbackground=document.createElement("canvas"),this.clearbackground.width=this.canvas.width,this.clearbackground.height=this.canvas.height;var a=this.background.getContext("2d");if(a.clearRect(0,0,this.canvas.width,this.canvas.height),a.globalAlpha=.3,a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.canvas.width,this.canvas.height),this.options.nightsky){var b=a.createLinearGradient(0,0,0,this.canvas.height);b.addColorStop(1,"rgba(0,0,51,0.25)"),b.addColorStop(0,"rgba(112,112,112,0.75)"),a.fillStyle=b,a.fillRect(0,0,this.canvas.width,this.canvas.height)}a=this.clearbackground.getContext("2d"),a.clearRect(0,0,this.canvas.width,this.canvas.height),a.globalAlpha=.3,a.drawImage(this.img,this.options.crop[0],this.options.crop[1],this.options.crop[2],this.options.crop[3],0,0,this.canvas.width,this.canvas.height),!isNaN(this.options.blur)&&this.options.blur>=1&&this.stackBlurCanvasRGB(this.canvas.width,this.canvas.height,this.options.blur)},b.prototype.stackBlurCanvasRGB=function(a,b,c){var e=[[0,9],[1,11],[2,12],[3,13],[5,14],[7,15],[11,16],[15,17],[22,18],[31,19],[45,20],[63,21],[90,22],[127,23],[181,24]],f=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];c|=0;var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=this.background.getContext("2d"),B=A.getImageData(0,0,a,b),C=B.data,D=c+1,E=D*(D+1)/2,F=new d,G=new d,H=F;for(i=1;2*c+1>i;i++)H=H.next=new d,i===D&&(G=H);H.next=F;var I=null,J=null;m=l=0;for(var K,L=f[c],M=0;M<e.length;++M)if(c<=e[M][0]){K=e[M-1][1];break}for(h=0;b>h;h++){for(t=u=v=n=o=p=0,q=D*(w=C[l]),r=D*(x=C[l+1]),s=D*(y=C[l+2]),n+=E*w,o+=E*x,p+=E*y,H=F,i=0;D>i;i++)H.r=w,H.g=x,H.b=y,H=H.next;for(i=1;D>i;i++)j=l+((i>a-1?a-1:i)<<2),n+=(H.r=w=C[j])*(z=D-i),o+=(H.g=x=C[j+1])*z,p+=(H.b=y=C[j+2])*z,t+=w,u+=x,v+=y,H=H.next;for(I=F,J=G,g=0;a>g;g++)C[l]=n*L>>K,C[l+1]=o*L>>K,C[l+2]=p*L>>K,n-=q,o-=r,p-=s,q-=I.r,r-=I.g,s-=I.b,j=m+((j=g+c+1)<a-1?j:a-1)<<2,t+=I.r=C[j],u+=I.g=C[j+1],v+=I.b=C[j+2],n+=t,o+=u,p+=v,I=I.next,q+=w=J.r,r+=x=J.g,s+=y=J.b,t-=w,u-=x,v-=y,J=J.next,l+=4;m+=a}for(g=0;a>g;g++){for(u=v=t=o=p=n=0,l=g<<2,q=D*(w=C[l]),r=D*(x=C[l+1]),s=D*(y=C[l+2]),n+=E*w,o+=E*x,p+=E*y,H=F,i=0;D>i;i++)H.r=w,H.g=x,H.b=y,H=H.next;for(k=a,i=1;D>i;i++)l=k+g<<2,n+=(H.r=w=C[l])*(z=D-i),o+=(H.g=x=C[l+1])*z,p+=(H.b=y=C[l+2])*z,t+=w,u+=x,v+=y,H=H.next,b-1>i&&(k+=a);for(l=g,I=F,J=G,h=0;b>h;h++)j=l<<2,C[j]=n*L>>K,C[j+1]=o*L>>K,C[j+2]=p*L>>K,n-=q,o-=r,p-=s,q-=I.r,r-=I.g,s-=I.b,j=g+((j=h+D)<b-1?j:b-1)*a<<2,n+=t+=I.r=C[j],o+=u+=I.g=C[j+1],p+=v+=I.b=C[j+2],I=I.next,q+=w=J.r,r+=x=J.g,s+=y=J.b,t-=w,u-=x,v-=y,J=J.next,l+=a}A.putImageData(B,0,0)},e.prototype.update=function(a,b){if(a.gid){if(!this.matrix[a.gmx]||!this.matrix[a.gmx][a.gmy])return null;if(this.matrix[a.gmx][a.gmy].remove(a),b)return null;if(a.gmx=Math.floor(a.x/this.resolution),a.gmy=Math.floor(a.y/this.resolution),!this.matrix[a.gmx]||!this.matrix[a.gmx][a.gmy])return null;this.matrix[a.gmx][a.gmy].add(a);var c=this.collisions(a);if(c&&null!=c.next)return c.next}else{if(a.gid=Math.random().toString(36).substr(2,9),a.gmx=Math.floor(a.x/this.resolution),a.gmy=Math.floor(a.y/this.resolution),!this.matrix[a.gmx]||!this.matrix[a.gmx][a.gmy])return null;this.matrix[a.gmx][a.gmy].add(a)}return null},e.prototype.collisions=function(a){var b=new f(null),c=b;return b=this.addAll(b,a.gmx-1,a.gmy+1),b=this.addAll(b,a.gmx,a.gmy+1),b=this.addAll(b,a.gmx+1,a.gmy+1),c},e.prototype.addAll=function(a,b,c){if(b>0&&c>0&&b<this.xc&&c<this.yc)for(var d=this.matrix[b][c];null!=d.next;)d=d.next,a.next=new f(d.drop),a=a.next;return a},e.prototype.remove=function(a){this.matrix[a.gmx][a.gmy].remove(a)},f.prototype.add=function(a){for(var b=this;null!=b.next;)b=b.next;b.next=new f(a)},f.prototype.remove=function(a){for(var b=this,c=null;null!=b.next;)c=b,b=b.next,b.drop.gid===a.gid&&(c.next=b.next)},rainfall=function(a,c){var d=new b({image:a,blur:8,opacity:80,nightsky:!0},c);d.rain([[1,0,20],[3,3,1]],100)};var i=$(".weather .weather_background")[0];rainfall(i,h)},1e3)}]}}]),angular.module("lightgalaApp").directive("repeatPassword",function(){
return{require:"ngModel",link:function(a,b,c,d){var e=b.inheritedData("$formController")[c.repeatPassword];d.$parsers.push(function(a){return a===e.$viewValue?(d.$setValidity("repeat",!0),a):void d.$setValidity("repeat",!1)}),e.$parsers.push(function(a){return d.$setValidity("repeat",a===d.$viewValue),a})}}}),angular.module("lightgalaApp").directive("snow",["$document",function(a){return{restrict:"EA",templateUrl:"../../partials/weather.html",controller:["$scope","$element","$timeout",function(b,c,d){d(function(){var b="http://www.w3.org/1999/xhtml",c=a[0].getElementsByTagNameNS(b,"canvas")[0],d=function(a){function b(){d.clearRect(0,0,e,f);var a=d.createLinearGradient(0,0,0,f);a.addColorStop(1,"white"),a.addColorStop(.9,"rgba(0,0,51,0.25)"),a.addColorStop(0,"rgba(112,112,112,0.75)"),d.fillStyle=a,d.fillRect(0,0,e,f),d.fillStyle="rgba(255, 255, 255, 0.8)",d.beginPath();for(var b=0;g>b;b++){var i=h[b];d.moveTo(i.x,i.y),d.arc(i.x,i.y,i.r,0,2*Math.PI,!0)}d.fill(),c()}function c(){j+=.01;for(var a=0;g>a;a++){var b=h[a];b.y+=Math.cos(j+b.d)+1+b.r/2,b.x+=2*Math.sin(j),(b.x>e+5||b.x<-5||b.y>f)&&(a%3>0?h[a]={x:Math.random()*e,y:-10,r:b.r,d:b.d}:Math.sin(j)>0?h[a]={x:-5,y:Math.random()*f,r:b.r,d:b.d}:h[a]={x:e+5,y:Math.random()*f,r:b.r,d:b.d})}}for(var d=a.getContext("2d"),e=a.width,f=a.height,g=100,h=[],i=0;g>i;i++)h.push({x:Math.random()*e,y:Math.random()*f,r:3*Math.random()+1,d:Math.random()*g});var j=0;setInterval(b,33)};d(c)},1e3)}]}}]),angular.module("lightgalaApp").directive("tools",["$timeout","utilService",function(a,b){return{restrict:"EA",templateUrl:"../../partials/tools.html",link:function(c,d,e){c.attachToolMenu=b.nceFunc(function(){for(var a,b=0;b<c.data.tools.length;b++)c.data.tools[b].options.length>0&&(a=c.data.tools[b].name,$("#tool-"+a).toolbar({content:"#options-"+a,position:"bottom",hideOnClick:!0}),$(".tool-item[toolbox-name="+a+"]").on("click",function(a){c.selectTool($(this).attr("name"))}))},2),c.$on("data_ready",function(b,d){a(c.attachToolMenu,1e3)}),c.current.music.totalMusics=c.app_data.musics.length,c.current.music.musicsPerPage=5,c.current.music.currentPage=1,c.current.music.maxSize=5,c.$watch("current.music.currentPage + current.music.musicsPerPage",function(){var a=(c.current.music.currentPage-1)*c.current.music.musicsPerPage,b=a+c.current.music.musicsPerPage;c.current.music.filteredMusics=c.app_data.musics.slice(a,b)})}}}]),angular.module("lightgalaApp").directive("widgets",["lightAnimService","utilService","$popover",function(a,b,c){return{restrict:"EA",templateUrl:"../../partials/widgets.html",link:function(c,d,e){var f=function(a,c){var d=["set","segment","start_second","color"],e=[{name:"begin",regex:"^([0-9.]+)s$"},{name:"dur",regex:"^([0-9.]+)s$"}],f=[{name:"calcmode",steps:[{value:"discrete",text:"N"},{value:"",text:"Y"}]},{name:"pattern_code",steps:[{value:"^[01]+$",text:"*"}]},{name:"stopcolor1",steps:[{value:"^hsl(d+,[d.]+%,[d.]+%)$",text:"*"}],when:{name:"colorname",regex:"^rgb$"}},{name:"stopcolor2",steps:[{value:"^hsl(d+,[d.]+%,[d.]+%)$",text:"*"}],when:{name:"colorname",regex:"^rgb$"}}],g=function(a,b,c){var d=_.find(f,function(b){return b.name==a}),e=_.findIndex(d.steps,function(a){return a.value==b||new RegExp(a.value,"i").test(b)});return v2_step_i_inc=(e+c)%d.steps.length,0==v2_step_i_inc?b:d.steps[v2_step_i_inc].value},h=_.filter(a,function(b){return b.decor_line_id==a[c].decor_line_id}).sort(b.dynamicSortMultiple("decor_line_id","start_second","set","segment","color")),i=_.findIndex(h,function(b){return angular.equals(b,a[c])});if(i>0){var j=_.filter(d,function(a){return h[i][a]!=h[i-1][a]}),k=_.filter(e,function(a){return h[i].config[a.name]!=h[i-1].config[a.name]||h[i+1]&&h[i].config[a.name]!=h[i+1].config[a.name]});if(1==j.length){j[0];for(value_i in k){var l=k[value_i],m=h[i].config[l.name],n=h[i-1].config[l.name],o=0,p=new RegExp(l.regex).exec(m),q=new RegExp(l.regex).exec(n);if(p&&q){o=Math.round(100*(parseFloat(p[1])-parseFloat(q[1])))/100;for(var r=i+1;r<h.length;r++){var s=_.findIndex(a,function(a){return angular.equals(a,h[r])});a[s].config[l.name]=Math.round(100*(parseFloat(p[1])+o*(r-i)))/100+"s"}}}for(value_i in f){var l=f[value_i].name,t=f[value_i].steps,u=f[value_i].when,m=h[i].config[l],v=_.findIndex(t,function(a){return a.value==m}),n=h[i-1].config[l],w=_.findIndex(t,function(a){return a.value==n});if(angular.isUndefined(u)||new RegExp(u.regex,"i").test(h[i].config[u.name])&&new RegExp(u.regex,"i").test(h[i-1].config[u.name]))for(var o=Math.abs(v-w),r=i+1;r<h.length;r++){var s=_.findIndex(a,function(a){return angular.equals(a,h[r])});a[s].config[l]=g(l,m,o*(r-i))}}}}};c.$watch("data.animations",function(b,d){for(var e=a.getAnim(),g=0;g<b.length;g++){var h=b[g],i=_.find(d,function(a){return a.color==h.color&&a.start_second==h.start_second&&a.decor_line_id==h.decor_line_id&&a.segment==h.segment&&a.set==h.set});if(!i){h.anim_id=e.formAnimId(h.decor_line_id,h.segment,h.set,h.color,h.start_second),c.decor_line_anim_enter_func&&c.decor_line_anim_enter_func(h.decor_line_id);break}if(!angular.equals(h.config,i.config)){g>0&&f(b,g),c.decor_line_anim_enter_func(h.decor_line_id);break}}},!0)}}}]);